var background=function(){"use strict";var ve=Object.defineProperty;var ke=(V,U,a)=>U in V?ve(V,U,{enumerable:!0,configurable:!0,writable:!0,value:a}):V[U]=a;var g=(V,U,a)=>ke(V,typeof U!="symbol"?U+"":U,a);var Mt,Ot;function V(i){return i==null||typeof i=="function"?{main:i}:i}const a=(Ot=(Mt=globalThis.browser)==null?void 0:Mt.runtime)!=null&&Ot.id?globalThis.browser:globalThis.chrome;var gt=(i=>(i[i.A1=1]="A1",i[i.A2=2]="A2",i[i.B1=3]="B1",i[i.B2=4]="B2",i[i.C1=5]="C1",i[i.C2=6]="C2",i))(gt||{}),mt=(i=>(i.DEFAULT="default",i.SUBTLE="subtle",i.BOLD="bold",i.ITALIC="italic",i.UNDERLINED="underlined",i.HIGHLIGHTED="highlighted",i.DOTTED="dotted",i.LEARNING="learning",i.CUSTOM="custom",i))(mt||{}),pt=(i=>(i.AUTOMATIC="automatic",i.MANUAL="manual",i))(pt||{}),wt=(i=>(i[i.VISIBLE=0]="VISIBLE",i[i.LEARNING=1]="LEARNING",i[i.HIDDEN=2]="HIDDEN",i))(wt||{}),yt=(i=>(i.BEFORE="before",i.AFTER="after",i))(yt||{}),St=(i=>(i.WORD="word",i.PARAGRAPH="paragraph",i))(St||{}),Et=(i=>(i.HOVER="hover",i.CLICK="click",i))(Et||{}),It=(i=>(i.AUTO="auto",i.BUTTON="button",i.SWIPE="swipe",i))(It||{});const Lt={apiKey:"YXBpLTEyMzQ1Ng==",apiEndpoint:"https://side-translation.planktonfly.com/v1/chat/completions",model:"gemini-3-flash-preview",temperature:parseFloat("0.2")||0,enable_thinking:!1,includeThinkingParam:!1,customParams:"",phraseEnabled:!0,requestsPerSecond:0,useBackgroundProxy:!1},Pt={nativeLanguage:"zh",targetLanguage:"en"},Rt={enabled:!0,modifierKeys:[],description:"å¿«æ·é”®"},Bt={enabled:!0,position:50,opacity:.8},Vt={enabled:!0,preloadDistance:1},Gt={enabled:!0,apiEndpoint:"https://side-translation.planktonfly.com/wordcard",selectCaptureMode:!0,dbClickCaptureMode:!1,singleClickCaptureMode:!1,showExplainIcon:!1,autoSpeak:!0,showEnglishDefinition:!0};function $t(){return{id:"default-config",name:"defaultConfig",provider:"openai",config:Lt,isDefault:!0,createdAt:Date.now(),updatedAt:Date.now()}}const w={userLevel:gt.B1,replacementRate:.3,isEnabled:!0,useGptApi:!0,apiConfigs:[$t()],activeApiConfigId:"default-config",translationStyle:mt.DEFAULT,translationMode:St.WORD,triggerMode:pt.MANUAL,maxLength:2e3,minLength:80,originalWordDisplayMode:wt.VISIBLE,enablePronunciationTooltip:!0,multilingualConfig:Pt,pronunciationHotkey:Rt,floatingBall:Bt,translationPosition:yt.AFTER,showParentheses:!0,apiRequestTimeout:0,customTranslationCSS:"",lazyLoading:Vt,ttsProvider:"google",pronunciationTriggerMode:Et.CLICK,translationTriggerMode:It.AUTO,showDebugPanel:!0,enableFullTextTTSBar:!0,enableWordLevelAnimation:!0,fullTextTTSBarCollapsed:!0,fullTextTTSConfigs:[{id:"default-tts-config",name:"Google Cloud TTS",config:{apiEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",apiKey:"AIzaSyCJV_CLwIhqiRI-5DobQZ7_YCc9i235m1Y",customParams:""},createdAt:Date.now(),updatedAt:Date.now()}],activeFullTextTTSConfigId:"default-tts-config",fullTextTTSVoiceName:"en-US-Chirp3-HD-Erinome",wordCard:Gt,paragraphTTS:{enabled:!0},gestureTranslation:{leftSwipe:!0,rightSwipe:!0},disableSystemSelectionBanner:!1};class Ft{async get(t){return(await a.storage.sync.get(t))[t]}async set(t,e){await a.storage.sync.set({[t]:e})}async remove(t){await a.storage.sync.remove(t)}}const zt=new Ft;var A=(i=>(i.SETTINGS_LOADED="settings_loaded",i.SETTINGS_SAVED="settings_saved",i.API_CONFIG_ADDED="api_config_added",i.API_CONFIG_UPDATED="api_config_updated",i.API_CONFIG_REMOVED="api_config_removed",i.ACTIVE_CONFIG_CHANGED="active_config_changed",i.DATA_CLEARED="data_cleared",i))(A||{});const _=class _{constructor(t={}){g(this,"config");g(this,"storageKey");g(this,"settingsStoragePort");g(this,"eventListeners",new Map);this.config={enableAutoBackup:!0,enableValidation:!0,maxRetries:3,storageKey:"user_settings",...t},this.storageKey=this.config.storageKey,this.settingsStoragePort=this.config.settingsStoragePort||zt}static getInstance(t){return _.instance||(_.instance=new _(t)),_.instance}addEventListener(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}removeEventListener(t,e){const s=this.eventListeners.get(t);if(s){const r=s.indexOf(e);r>-1&&s.splice(r,1)}}emitEvent(t,e,s){const r={type:t,timestamp:Date.now(),data:e,error:s},n=this.eventListeners.get(t);n&&n.forEach(o=>{try{o(r)}catch(d){console.error("Storage event listener error:",d)}})}async getUserSettings(){try{const t=await this.settingsStoragePort.get(_.STORAGE_KEY);if(!t)return this.emitEvent(A.SETTINGS_LOADED,w),w;const e=JSON.parse(String(t));if(this.isOldFormatConfig(e))return await this.saveUserSettings(w),this.emitEvent(A.SETTINGS_LOADED,w),w;const s=this.validateAndFixSettings(e);return this.hasConfigurationChanged(e,s)&&await this.saveUserSettings(s),this.emitEvent(A.SETTINGS_LOADED,s),s}catch(t){const e=`è·å–ç”¨æˆ·è®¾ç½®å¤±è´¥: ${t}`;return console.error(e),this.emitEvent(A.SETTINGS_LOADED,w,e),w}}async saveUserSettings(t){try{this.config.enableValidation&&(t=this.validateAndFixSettings(t));const e=JSON.stringify(t);return await this.settingsStoragePort.set(this.storageKey,e),this.emitEvent(A.SETTINGS_SAVED,t),{success:!0,data:t}}catch(e){const s=`ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥: ${e}`;return console.error(s),this.emitEvent(A.SETTINGS_SAVED,null,s),{success:!1,error:s}}}async getActiveApiConfig(){try{const t=await this.getUserSettings(),e=t.apiConfigs.find(s=>s.id===t.activeApiConfigId);return(e==null?void 0:e.config)||null}catch(t){return console.error("è·å–æ´»è·ƒAPIé…ç½®å¤±è´¥:",t),null}}async setActiveApiConfig(t){try{const e=await this.getUserSettings();if(!e.apiConfigs.some(n=>n.id===t)){const n=`APIé…ç½® ${t} ä¸å­˜åœ¨`;return console.error(n),{success:!1,error:n}}e.activeApiConfigId=t;const r=await this.saveUserSettings(e);return r.success&&this.emitEvent(A.ACTIVE_CONFIG_CHANGED,{configId:t}),r}catch(e){const s=`è®¾ç½®æ´»è·ƒAPIé…ç½®å¤±è´¥: ${e}`;return console.error(s),{success:!1,error:s}}}async addApiConfig(t,e,s){try{const r=await this.getUserSettings(),n=Date.now(),o={id:`config-${n}`,name:t,provider:e,config:s,isDefault:!1,createdAt:n,updatedAt:n};r.apiConfigs.push(o);const d=await this.saveUserSettings(r);return d.success?(this.emitEvent(A.API_CONFIG_ADDED,o),{success:!0,data:o.id}):d}catch(r){const n=`æ·»åŠ APIé…ç½®å¤±è´¥: ${r}`;return console.error(n),{success:!1,error:n}}}async updateApiConfig(t,e,s,r){try{const n=await this.getUserSettings(),o=n.apiConfigs.findIndex(f=>f.id===t);if(o===-1){const f=`APIé…ç½® ${t} ä¸å­˜åœ¨`;return console.error(f),{success:!1,error:f}}const d={...n.apiConfigs[o],name:e,provider:s,config:r,updatedAt:Date.now()};n.apiConfigs[o]=d;const m=await this.saveUserSettings(n);return m.success&&this.emitEvent(A.API_CONFIG_UPDATED,d),m}catch(n){const o=`æ›´æ–°APIé…ç½®å¤±è´¥: ${n}`;return console.error(o),{success:!1,error:o}}}async removeApiConfig(t){try{const e=await this.getUserSettings(),s=e.apiConfigs.find(n=>n.id===t);if(s!=null&&s.isDefault){const n="ä¸èƒ½åˆ é™¤é»˜è®¤é…ç½®";return console.error(n),{success:!1,error:n}}if(e.activeApiConfigId===t){const n=e.apiConfigs.find(o=>o.id!==t);n&&(e.activeApiConfigId=n.id)}e.apiConfigs=e.apiConfigs.filter(n=>n.id!==t);const r=await this.saveUserSettings(e);return r.success&&this.emitEvent(A.API_CONFIG_REMOVED,{configId:t}),r}catch(e){const s=`åˆ é™¤APIé…ç½®å¤±è´¥: ${e}`;return console.error(s),{success:!1,error:s}}}async clearAllData(){try{return await this.settingsStoragePort.remove(this.storageKey),this.emitEvent(A.DATA_CLEARED),{success:!0}}catch(t){const e=`æ¸…é™¤æ•°æ®å¤±è´¥: ${t}`;return console.error(e),{success:!1,error:e}}}async getConfigStats(){try{const t=await this.getUserSettings();return{intelligentModeEnabled:!0,targetLanguage:t.multilingualConfig.targetLanguage,totalKeys:Object.keys(t).length,apiConfigsCount:t.apiConfigs.length}}catch(t){return console.error("è·å–é…ç½®ç»Ÿè®¡å¤±è´¥:",t),{intelligentModeEnabled:!0,targetLanguage:"en",totalKeys:0,apiConfigsCount:0}}}isOldFormatConfig(t){const e=t.multilingualConfig;return e?"intelligentMode"in e||"enableNativeSwitch"in e||"sourceLanguageOverride"in e:!1}validateAndFixSettings(t){const e={...t};try{const s={...w,...e,multilingualConfig:{...w.multilingualConfig,...e.multilingualConfig||{}},pronunciationHotkey:{...w.pronunciationHotkey,...e.pronunciationHotkey||{}},floatingBall:{...w.floatingBall,...e.floatingBall||{}},lazyLoading:{...w.lazyLoading,...e.lazyLoading||{}},wordCard:{...w.wordCard,...e.wordCard||{}},paragraphTTS:{...w.paragraphTTS,...e.paragraphTTS||{}},gestureTranslation:{...w.gestureTranslation,...e.gestureTranslation||{}}};return s.apiConfigs||(s.apiConfigs=w.apiConfigs),s.activeApiConfigId||s.apiConfigs.length>0&&(s.activeApiConfigId=s.apiConfigs[0].id),s.activeApiConfigId&&!s.apiConfigs.some(n=>n.id===s.activeApiConfigId)&&s.apiConfigs.length>0&&(s.activeApiConfigId=s.apiConfigs[0].id),s.multilingualConfig||(s.multilingualConfig=w.multilingualConfig),s.lazyLoading||(s.lazyLoading=w.lazyLoading),s}catch(s){return console.error(`è®¾ç½®éªŒè¯å¼‚å¸¸: ${s}`),w}}hasConfigurationChanged(t,e){try{return JSON.stringify(t)!==JSON.stringify(e)}catch{return!0}}};g(_,"instance"),g(_,"STORAGE_KEY","user_settings");let G=_;G.getInstance();class Ht extends Error{constructor(t,e,s){super(t),this.code=e,this.context=s,this.name="BackgroundServiceError"}}class q extends Ht{constructor(t,e){super(t,"NOTIFICATION_ERROR",e),this.name="NotificationError"}}const b={NOTIFICATION_TIMEOUT:5e3,API_REQUEST_TIMEOUT:3e4,SESSION_KEY_API_NOTIFICATION:"apiKeyNotificationShown",MENU_PARENT_ID:"illa-website-management",WARNING_ICON_PATH:"/warning.png",OPTIONS_PATH:"/options.html"},x={SHOW_NOTIFICATION:"show-notification",OPEN_POPUP:"open-popup",OPEN_OPTIONS:"open-options",VALIDATE_CONFIG:"validate-configuration",API_REQUEST:"api-request",SETTINGS_UPDATED:"settings_updated",API_CONFIG_UPDATED:"api_config_updated",SET_SELECTION_BANNER_DISABLED:"SET_SELECTION_BANNER_DISABLED"},Tt={TRANSLATE_PAGE:"translate-page"},M=class M{constructor(){g(this,"config");this.config={defaultIconUrl:b.WARNING_ICON_PATH,defaultTimeout:b.NOTIFICATION_TIMEOUT,sessionStorageKey:b.SESSION_KEY_API_NOTIFICATION}}static getInstance(){return M.instance||(M.instance=new M),M.instance}async showNotification(t){try{return await a.notifications.create({type:"basic",iconUrl:t.iconUrl||a.runtime.getURL("/warning.png"),title:t.title,message:t.message})||""}catch(e){throw console.error("åˆ›å»ºé€šçŸ¥å¤±è´¥:",e),new q(`åˆ›å»ºé€šçŸ¥å¤±è´¥: ${e instanceof Error?e.message:"æœªçŸ¥é”™è¯¯"}`,{notificationConfig:t})}}async showApiConfigError(t){const e={type:"basic",title:"[æµ¸å…¥å¼å­¦è¯­è¨€åŠ©æ‰‹] API é…ç½®é”™è¯¯",message:"API å¯†é’¥æœªè®¾ç½®ã€‚è¯·ç‚¹å‡»æ‰©å±•å›¾æ ‡è¿›å…¥è®¾ç½®é¡µé¢è¿›è¡Œé…ç½®ã€‚",iconUrl:a.runtime.getURL("/warning.png")};try{t==="user_action"?await this.showNotification(e):await this.hasShownSessionNotification()||(await this.showNotification(e),await this.markSessionNotificationShown())}catch(s){throw console.error("æ˜¾ç¤ºAPIé…ç½®é”™è¯¯é€šçŸ¥å¤±è´¥:",s),s}}async showSuccessNotification(t,e,s){return this.showNotification({type:"basic",title:t,message:e,iconUrl:s||a.runtime.getURL("/icon/48.png")})}async showErrorNotification(t,e,s){return this.showNotification({type:"basic",title:t,message:s?`${e}: ${s.message}`:e,iconUrl:a.runtime.getURL("/warning.png")})}async showWarningNotification(t,e){const s={type:"basic",title:t,message:e,iconUrl:a.runtime.getURL("/warning.png"),priority:1};return this.showNotification(s)}async showProgressNotification(t,e,s){const r={type:"progress",title:t,message:e,iconUrl:a.runtime.getURL("/icon/48.png"),priority:1,progress:Math.max(0,Math.min(100,s))};try{return await a.notifications.create(r)||""}catch(n){throw console.error("åˆ›å»ºè¿›åº¦é€šçŸ¥å¤±è´¥:",n),new q(`åˆ›å»ºè¿›åº¦é€šçŸ¥å¤±è´¥: ${n instanceof Error?n.message:"æœªçŸ¥é”™è¯¯"}`,{title:t,message:e,progress:s})}}async updateProgressNotification(t,e,s){try{const r={progress:Math.max(0,Math.min(100,e))};s&&(r.message=s),await a.notifications.update(t,r)}catch(r){throw console.error("æ›´æ–°è¿›åº¦é€šçŸ¥å¤±è´¥:",r),new q(`æ›´æ–°è¿›åº¦é€šçŸ¥å¤±è´¥: ${r instanceof Error?r.message:"æœªçŸ¥é”™è¯¯"}`,{notificationId:t,progress:e,message:s})}}async clearNotification(t){try{await a.notifications.clear(t)}catch(e){throw console.error("æ¸…é™¤é€šçŸ¥å¤±è´¥:",e),new q(`æ¸…é™¤é€šçŸ¥å¤±è´¥: ${e instanceof Error?e.message:"æœªçŸ¥é”™è¯¯"}`,{notificationId:t})}}async clearAllNotifications(){try{const t=await a.notifications.getAll(),e=Object.keys(t).map(s=>this.clearNotification(s));await Promise.all(e)}catch(t){throw console.error("æ¸…é™¤æ‰€æœ‰é€šçŸ¥å¤±è´¥:",t),new q(`æ¸…é™¤æ‰€æœ‰é€šçŸ¥å¤±è´¥: ${t instanceof Error?t.message:"æœªçŸ¥é”™è¯¯"}`)}}async hasShownSessionNotification(){try{return!!(await a.storage.session.get(this.config.sessionStorageKey))[this.config.sessionStorageKey]}catch(t){return console.error("æ£€æŸ¥ä¼šè¯é€šçŸ¥çŠ¶æ€å¤±è´¥:",t),!1}}async markSessionNotificationShown(){try{await a.storage.session.set({[this.config.sessionStorageKey]:!0})}catch(t){console.error("æ ‡è®°ä¼šè¯é€šçŸ¥çŠ¶æ€å¤±è´¥:",t)}}async resetSessionNotificationStatus(){try{await a.storage.session.remove(this.config.sessionStorageKey)}catch(t){console.error("é‡ç½®ä¼šè¯é€šçŸ¥çŠ¶æ€å¤±è´¥:",t)}}setNotificationClickListener(t){var e;(e=a.notifications)!=null&&e.onClicked&&a.notifications.onClicked.addListener(t)}setNotificationButtonClickListener(t){a.notifications.onButtonClicked&&a.notifications.onButtonClicked.addListener(t)}setNotificationCloseListener(t){var e;(e=a.notifications)!=null&&e.onClosed&&a.notifications.onClosed.addListener(t)}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}async checkNotificationPermission(){try{return a.notifications!==void 0}catch(t){return console.error("æ£€æŸ¥é€šçŸ¥æƒé™å¤±è´¥:",t),!1}}destroy(){M.instance=null}};g(M,"instance",null);let st=M;const O=class O{constructor(){g(this,"config");g(this,"activeRequests",new Map);this.config={defaultTimeout:b.API_REQUEST_TIMEOUT,maxRetries:3,retryDelay:1e3}}static getInstance(){return O.instance||(O.instance=new O),O.instance}async handleApiRequest(t){const{url:e,method:s,headers:r,body:n,timeout:o}=t.data;let d;try{const m=new AbortController;o&&o>0&&(d=setTimeout(()=>m.abort(),o));const f=await fetch(e,{method:s,headers:r,body:n,signal:m.signal});d&&clearTimeout(d);const p=await f.text();let y;try{y=JSON.parse(p)}catch{y=p}return f.ok?{success:!0,data:y}:{success:!1,error:{message:`HTTP ${f.status}: ${f.statusText}`,status:f.status,statusText:f.statusText}}}catch(m){console.error("Background APIè¯·æ±‚å¤±è´¥:",m);let f="è¯·æ±‚å¤±è´¥";return m.name==="AbortError"?f="è¯·æ±‚è¶…æ—¶":m.message&&(f=m.message),{success:!1,error:{message:f}}}}cancelAllRequests(){this.activeRequests.forEach(t=>{t.abort()}),this.activeRequests.clear()}updateConfig(t){this.config={...this.config,...t}}destroy(){this.cancelAllRequests(),O.instance=null}};g(O,"instance",null);let it=O;const L=class L{constructor(){g(this,"config");g(this,"storageService");this.config={enabledCommands:["translate-page"],requiresValidation:!0},this.storageService=G.getInstance()}static getInstance(){return L.instance||(L.instance=new L),L.instance}initialize(){a.commands.onCommand.addListener(this.handleCommand.bind(this))}async handleCommand(t){if(this.isCommandEnabled(t))try{const e=await this.executeCommand(t);!e.success&&e.error&&console.error(`[CommandService] å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${e.error}`)}catch(e){console.error("[CommandService] å‘½ä»¤æ‰§è¡Œå¼‚å¸¸:",e)}}async executeCommand(t){switch(t){case Tt.TRANSLATE_PAGE:return this.handleTranslatePageCommand();default:return{success:!1,error:`æœªçŸ¥å‘½ä»¤: ${t}`}}}async handleTranslatePageCommand(){var t;try{if(this.config.requiresValidation&&!(await this.validateApiConfiguration()).isValid)return{success:!1,error:"APIé…ç½®æ— æ•ˆ"};const e=await a.tabs.query({active:!0,currentWindow:!0});return(t=e[0])!=null&&t.id?(await a.tabs.sendMessage(e[0].id,{type:"translate-page-command"}),{success:!0}):{success:!1,error:"æ— æ³•è·å–å½“å‰æ ‡ç­¾é¡µ"}}catch(e){return console.error("[CommandService] ç¿»è¯‘é¡µé¢å‘½ä»¤æ‰§è¡Œå¤±è´¥:",e),{success:!1,error:e instanceof Error?e.message:"æœªçŸ¥é”™è¯¯"}}}async validateApiConfiguration(){var t,e;try{const s=await this.storageService.getUserSettings(),r=(t=s.apiConfigs)==null?void 0:t.find(o=>o.id===s.activeApiConfigId);return!((e=r==null?void 0:r.config)!=null&&e.apiKey)?{isValid:!1,errors:["APIå¯†é’¥æœªè®¾ç½®"]}:{isValid:!0,activeConfig:{id:r.id,provider:r.provider,hasApiKey:!!r.config.apiKey},errors:[]}}catch(s){return console.error("[CommandService] é…ç½®éªŒè¯å¤±è´¥:",s),{isValid:!1,errors:["é…ç½®éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"]}}}isCommandEnabled(t){return this.config.enabledCommands.includes(t)}enableCommand(t){this.config.enabledCommands.includes(t)||this.config.enabledCommands.push(t)}disableCommand(t){const e=this.config.enabledCommands.indexOf(t);e>-1&&this.config.enabledCommands.splice(e,1)}getEnabledCommands(){return[...this.config.enabledCommands]}setRequiresValidation(t){this.config.requiresValidation=t}async executeManualCommand(t){return this.isCommandEnabled(t)?this.executeCommand(t):{success:!1,error:`å‘½ä»¤æœªå¯ç”¨: ${t}`}}getAvailableCommands(){return Object.values(Tt)}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}getCommandStats(){return{enabledCommands:this.config.enabledCommands.length,totalCommands:this.getAvailableCommands().length,requiresValidation:this.config.requiresValidation}}destroy(){L.instance=null}};g(L,"instance",null);let rt=L;function j(i){try{return new URL(i).hostname}catch{const e=i.match(/(?:https?:\/\/)?(?:www\.)?([^\/]+)/);return e?e[1]:i}}function W(i){return`*://${i.replace(/^www\./,"")}/*`}function At(i){try{const t=new URL(i),e=t.pathname.endsWith("/")?t.pathname:`${t.pathname}*`;return`${t.protocol}//${t.host}${e}`}catch{return i}}function Kt(i,t){const e=t==="blacklist"?"é»‘åå•":"ç™½åå•";if(i.includes("*://")&&i.endsWith("/*")){const s=i.replace(/^\*:\/\//,"").replace(/\/\*$/,"");return`${e} - åŸŸå: ${s}`}else return`${e} - é¡µé¢: ${i}`}function qt(i){const t=["chrome:","chrome-extension:","moz-extension:","edge:","about:"],e=i.includes("localhost")||i.includes("127.0.0.1"),s=t.some(r=>i.startsWith(r));return e||s}function Wt(i){if(!i||i.trim()==="")return{valid:!1,error:"URLä¸èƒ½ä¸ºç©º"};if(qt(i))return{valid:!1,error:"æ— æ³•ä¸ºæµè§ˆå™¨å†…éƒ¨é¡µé¢æˆ–æœ¬åœ°åœ°å€åˆ›å»ºè§„åˆ™"};try{return new URL(i),{valid:!0}}catch{return{valid:!1,error:"URLæ ¼å¼æ— æ•ˆ"}}}class jt{constructor(t){g(this,"websiteManager");this.websiteManager=t}async init(){var t,e;try{a.contextMenus.onClicked.addListener(this.handleMenuClick.bind(this)),a.tabs.onUpdated.addListener(this.handleTabUpdate.bind(this)),a.tabs.onActivated.addListener(this.handleTabActivated.bind(this)),a.webNavigation.onCommitted.addListener(this.handleNavigation.bind(this));const s=await a.tabs.query({active:!0,currentWindow:!0});(t=s[0])!=null&&t.id&&((e=s[0])!=null&&e.url)&&await this.updateMenuState(s[0].id,s[0].url)}catch(s){console.error("èœå•ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:",s)}}async updateMenuState(t,e){if(!e||!e.startsWith("http")){await this.hideAllDynamicMenus();return}try{if(!Wt(e).valid){await this.hideAllDynamicMenus();return}const r=await this.websiteManager.getWebsiteStatus(e),n=j(e);await this.updateMenuVisibility(e,n,r)}catch(s){console.error("[ContextMenu] æ›´æ–°èœå•çŠ¶æ€å¤±è´¥:",{error:s instanceof Error?s.message:"æœªçŸ¥é”™è¯¯",url:e,tabId:t,stack:s instanceof Error?s.stack:void 0});try{const r=await this.websiteManager.getWebsiteStatus(e),n=j(e);await this.updateMenuVisibility(e,n,r)}catch(r){console.error("[ContextMenu] é‡è¯•å¤±è´¥ï¼Œéšè—æ‰€æœ‰èœå•:",r),await this.hideAllDynamicMenus()}}}async updateMenuVisibility(t,e,s){await this.hideAllDynamicMenus();try{s==="blacklisted"?(await a.contextMenus.update("illa-remove-blacklist",{visible:!0,title:`ä»é»‘åå•ä¸­ç§»é™¤ ${e}`}),await a.contextMenus.update("illa-add-whitelist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°ç™½åå•`}),await a.contextMenus.update("illa-add-whitelist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°ç™½åå•"})):s==="whitelisted"?(await a.contextMenus.update("illa-remove-whitelist",{visible:!0,title:`ä»ç™½åå•ä¸­ç§»é™¤ ${e}`}),await a.contextMenus.update("illa-add-blacklist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°é»‘åå•`}),await a.contextMenus.update("illa-add-blacklist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°é»‘åå•"})):(await a.contextMenus.update("illa-add-blacklist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°é»‘åå•`}),await a.contextMenus.update("illa-add-blacklist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°é»‘åå•"}),await a.contextMenus.update("illa-add-whitelist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°ç™½åå•`}),await a.contextMenus.update("illa-add-whitelist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°ç™½åå•"}))}catch(r){console.error("æ›´æ–°èœå•å¯è§æ€§å¤±è´¥:",r)}}async hideAllDynamicMenus(){const t=["illa-add-blacklist-domain","illa-add-blacklist-exact","illa-remove-blacklist","illa-add-whitelist-domain","illa-add-whitelist-exact","illa-remove-whitelist"];for(const e of t)try{await a.contextMenus.update(e,{visible:!1})}catch(s){console.error("æ›´æ–°èœå•å¯è§æ€§å¤±è´¥:",s)}}async handleMenuClick(t,e){if(!(e!=null&&e.url)){this.showNotification("æ“ä½œå¤±è´¥","æ— æ³•è·å–å½“å‰é¡µé¢ä¿¡æ¯");return}try{const s=e.url,r=j(s);if(t.menuItemId==="illa-open-settings"){const n=a.runtime.getURL("/options.html#website-management");await a.tabs.create({url:n});return}typeof t.menuItemId=="string"&&await this.processMenuAction(t.menuItemId,s,r)}catch(s){console.error("[ContextMenu] å¤„ç†èœå•ç‚¹å‡»å¤±è´¥:",{error:s instanceof Error?s.message:"æœªçŸ¥é”™è¯¯",menuItemId:t.menuItemId,url:e==null?void 0:e.url,stack:s instanceof Error?s.stack:void 0}),this.showNotification("æ“ä½œå¤±è´¥","å¤„ç†èœå•æ“ä½œæ—¶å‘ç”Ÿé”™è¯¯")}}async processMenuAction(t,e,s){let r,n,o;if(t.includes("add-blacklist-domain"))r="add-to-blacklist",n="domain",o=W(s);else if(t.includes("add-blacklist-exact"))r="add-to-blacklist",n="exact",o=At(e);else if(t.includes("add-whitelist-domain"))r="add-to-whitelist",n="domain",o=W(s);else if(t.includes("add-whitelist-exact"))r="add-to-whitelist",n="exact",o=At(e);else if(t.includes("remove-blacklist"))r="remove-from-blacklist",n="domain",o=W(s);else if(t.includes("remove-whitelist"))r="remove-from-whitelist",n="domain",o=W(s);else return;await this.executeAction(r,o,n,e)}async executeAction(t,e,s,r){var n,o;try{const d=t.includes("blacklist")?"blacklist":"whitelist",m=Kt(e,d);if(t.startsWith("add-to-")){await this.websiteManager.addRule(e,d,m);const p=d==="blacklist"?"é»‘åå•":"ç™½åå•",y=s==="domain"?"ç½‘ç«™":"é¡µé¢";this.showNotification("è§„åˆ™æ·»åŠ æˆåŠŸ",`å·²å°†${y}æ·»åŠ åˆ°${p}`)}else if(t.startsWith("remove-from-")){const p=await this.websiteManager.getRulesByType(d),y=j(r),h=W(y),S=p.filter(R=>{if(R.pattern===e||R.pattern===h)return!0;const ht=`*.${y}`;return R.pattern===ht});for(const R of S)await this.websiteManager.removeRule(R.id);const k=d==="blacklist"?"é»‘åå•":"ç™½åå•",K=S.length>0?"ç›¸å…³è§„åˆ™":"åŒ¹é…è§„åˆ™";this.showNotification("è§„åˆ™ç§»é™¤æˆåŠŸ",`å·²ä»${k}ä¸­ç§»é™¤${K}`)}const f=await a.tabs.query({active:!0,currentWindow:!0});(n=f[0])!=null&&n.id&&((o=f[0])!=null&&o.url)&&await this.updateMenuState(f[0].id,f[0].url)}catch(d){console.error("[ContextMenu] æ‰§è¡Œæ“ä½œå¤±è´¥:",{error:d instanceof Error?d.message:"æœªçŸ¥é”™è¯¯",action:t,pattern:e,patternType:s,url:r,stack:d instanceof Error?d.stack:void 0}),this.showNotification("æ“ä½œå¤±è´¥","æ‰§è¡Œæ“ä½œæ—¶å‘ç”Ÿé”™è¯¯")}}showNotification(t,e){a.notifications.create({type:"basic",iconUrl:a.runtime.getURL("/icon/48.png"),title:t,message:e})}async handleTabUpdate(t,e,s){(e.url||e.status==="complete"&&s.url||e.title)&&await this.updateMenuState(t,s.url)}async handleTabActivated(t){try{const e=await a.tabs.get(t.tabId);e.url&&await this.updateMenuState(t.tabId,e.url)}catch(e){console.error("å¤„ç†æ ‡ç­¾é¡µæ¿€æ´»äº‹ä»¶å¤±è´¥:",e)}}async handleNavigation(t){t.frameId===0&&t.url&&await this.updateMenuState(t.tabId,t.url)}}const Yt=["\\","/",".","*","+","?","|","(",")","[","]","{","}","$","^"],Jt=i=>{let t="",e=0;for(;e<i.length;){const s=i[e++];switch(s){case"*":t+=".*";break;case"?":t+=".";break;case"[":let r="",n="";for(i[e]==="!"&&(r="^",e++);i[e]!=="]"&&i[e];){const o=i[e++];o==="-"?i[e]&&n?(r+=n+"-"+i[e++],n=""):(r+="\\-",n=""):(r+=o,n=o)}e++,t+="["+r+"]";break;case"\\":t+="\\"+i[e++];break;default:Yt.indexOf(s)>-1&&(t+="\\"),t+=s;break}}return new RegExp("^"+t+"$")},Ct={match:(i,t)=>Jt(i).test(t)},Y={rules:[]},J="website-management-settings",nt="blacklist-settings";class Qt{constructor(){g(this,"settingsCache",null);g(this,"cacheTimestamp",null)}async getWebsiteStatus(t){const e=await this.getSettings(),s=Date.now();this.cacheTimestamp&&s-this.cacheTimestamp>5e3&&this.clearCache();const r=e.rules.filter(o=>o.type==="blacklist"&&o.enabled);for(const o of r)if(Ct.match(o.pattern,t))return"blacklisted";const n=e.rules.filter(o=>o.type==="whitelist"&&o.enabled);for(const o of n)if(Ct.match(o.pattern,t))return"whitelisted";return"normal"}async isBlacklisted(t){return await this.getWebsiteStatus(t)==="blacklisted"}async isWhitelisted(t){return await this.getWebsiteStatus(t)==="whitelisted"}async getRules(){return(await this.getSettings()).rules}async getRulesByType(t){return this.clearCache(),(await this.getSettings()).rules.filter(s=>s.type===t)}async addRule(t,e,s){if(!t)return;this.clearCache();const r=await this.getSettings(),n=r.rules.find(d=>d.pattern===t);if(n){if(n.type===e)return;{const d=r.rules.findIndex(m=>m.id===n.id);d>-1&&r.rules.splice(d,1)}}const o={id:this.generateId(),pattern:t,type:e,enabled:!0,createdAt:new Date,description:s};r.rules.push(o),await this.saveSettings(r),this.clearCache()}async updateRule(t,e){const s=await this.getSettings(),r=s.rules.findIndex(n=>n.id===t);if(r===-1)throw new Error("è§„åˆ™ä¸å­˜åœ¨");s.rules[r]={...s.rules[r],...e},await this.saveSettings(s),this.clearCache()}async removeRule(t){const e=await this.getSettings(),s=e.rules.findIndex(r=>r.id===t);s>-1&&(e.rules.splice(s,1),await this.saveSettings(e),this.clearCache())}async removeRules(t){const e=await this.getSettings();e.rules=e.rules.filter(s=>!t.includes(s.id)),await this.saveSettings(e),this.clearCache()}async toggleRule(t){const e=await this.getSettings(),s=e.rules.find(r=>r.id===t);s&&(s.enabled=!s.enabled,await this.saveSettings(e),this.clearCache())}async getSettings(){if(this.settingsCache)return this.settingsCache;try{const t=await a.storage.sync.get(J);if(t&&t[J]){const s=JSON.parse(t[J]);return s.rules&&(s.rules=s.rules.map(r=>({...r,createdAt:new Date(r.createdAt)}))),this.settingsCache=s,this.cacheTimestamp=Date.now(),s}const e=await a.storage.sync.get(nt);if(e&&e[nt]){const s=JSON.parse(e[nt]),r=await this.migrateLegacyData(s);return this.settingsCache=r,r}return this.settingsCache=Y,Y}catch(t){return console.error("è·å–ç½‘ç«™ç®¡ç†è®¾ç½®å¤±è´¥:",t),this.settingsCache=Y,Y}}async migrateLegacyData(t){const s={rules:t.patterns.map(r=>({id:this.generateId(),pattern:r,type:"blacklist",enabled:!0,createdAt:new Date,description:"ä»é»‘åå•è¿ç§»"}))};return await this.saveSettings(s),s}async saveSettings(t){try{const e=JSON.stringify(t);await a.storage.sync.set({[J]:e}),this.settingsCache=t,this.cacheTimestamp=Date.now()}catch(e){console.error("ä¿å­˜ç½‘ç«™ç®¡ç†è®¾ç½®å¤±è´¥:",e)}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}clearCache(){this.settingsCache=null,this.cacheTimestamp=null}}const P=class P{constructor(){g(this,"storageService");g(this,"contextMenuManager");g(this,"websiteManager");g(this,"runtimeInitialized",!1);this.storageService=G.getInstance(),this.websiteManager=new Qt,this.contextMenuManager=new jt(this.websiteManager)}static getInstance(){return P.instance||(P.instance=new P),P.instance}async initializeRuntime(){if(!this.runtimeInitialized)try{await this.contextMenuManager.init(),this.runtimeInitialized=!0}catch(t){console.error("[InitializationService] è¿è¡Œæ—¶åˆå§‹åŒ–å¤±è´¥:",t)}}async handleInstallation(t){const e={success:!0,errors:[],warnings:[]};try{t.reason==="install"&&await this.performFirstTimeSetup(e),await this.initializeMenus(e)}catch(s){e.success=!1,e.errors.push(`åˆå§‹åŒ–å¤±è´¥: ${s instanceof Error?s.message:"æœªçŸ¥é”™è¯¯"}`)}return e}async performFirstTimeSetup(t){try{await this.storageService.saveUserSettings(w)}catch(e){t.errors.push("ä¿å­˜é»˜è®¤è®¾ç½®å¤±è´¥"+e);try{await a.storage.sync.set(w),t.warnings.push("ä½¿ç”¨äº†å¤‡ç”¨å­˜å‚¨æ–¹å¼")}catch(s){t.errors.push("å¤‡ç”¨å­˜å‚¨æ–¹å¼ä¹Ÿå¤±è´¥äº†"+s)}}}async initializeMenus(t){try{await this.createContextMenus()}catch(e){t.errors.push("å³é”®èœå•åˆå§‹åŒ–å¤±è´¥"+e)}}async createContextMenus(){await a.contextMenus.removeAll(),await a.contextMenus.create({id:b.MENU_PARENT_ID,title:"æµ¸å…¥å¼å­¦è¯­è¨€åŠ©æ‰‹",contexts:["page"]}),await a.contextMenus.create({id:"illa-separator",type:"separator",parentId:b.MENU_PARENT_ID,contexts:["page"]});const t=[{id:"illa-add-blacklist-domain",title:"æ·»åŠ åŸŸååˆ°é»‘åå•",visible:!1},{id:"illa-add-blacklist-exact",title:"æ·»åŠ å½“å‰é¡µé¢åˆ°é»‘åå•",visible:!1},{id:"illa-remove-blacklist",title:"ä»é»‘åå•ä¸­ç§»é™¤",visible:!1},{id:"illa-add-whitelist-domain",title:"æ·»åŠ åŸŸååˆ°ç™½åå•",visible:!1},{id:"illa-add-whitelist-exact",title:"æ·»åŠ å½“å‰é¡µé¢åˆ°ç™½åå•",visible:!1},{id:"illa-remove-whitelist",title:"ä»ç™½åå•ä¸­ç§»é™¤",visible:!1}];for(const e of t)await a.contextMenus.create({id:e.id,title:e.title,parentId:b.MENU_PARENT_ID,contexts:["page"],visible:e.visible});await a.contextMenus.create({id:"illa-settings-separator",type:"separator",parentId:b.MENU_PARENT_ID,contexts:["page"]}),await a.contextMenus.create({id:"illa-open-settings",title:"ç½‘ç«™ç®¡ç†è®¾ç½®",parentId:b.MENU_PARENT_ID,contexts:["page"]})}destroy(){P.instance=null}};g(P,"instance",null);let at=P;const $=class ${constructor(){g(this,"currentVersion");g(this,"checkInterval",864e5);g(this,"githubApiUrl","https://api.github.com/repos/xiao-zaiyi/illa-helper/releases/latest");g(this,"storageService");g(this,"intervalId");this.currentVersion=a.runtime.getManifest().version,this.storageService=G.getInstance()}static getInstance(){return $.instance||($.instance=new $),$.instance}async init(){setTimeout(()=>{this.checkForUpdates()},1e4),this.schedulePeriodicCheck(),this.setupNotificationListeners(),await this.checkPendingUpdate()}destroy(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0)}schedulePeriodicCheck(){this.intervalId=setInterval(()=>{this.checkForUpdates()},this.checkInterval)}async handleMessage(t,e){switch(t.type){case"CHECK_UPDATE":try{const s=await this.checkForUpdates(!0);e(s)}catch(s){e({hasUpdate:!1,error:s instanceof Error?s.message:String(s)})}return!0;case"CLEAR_UPDATE_BADGE":try{await this.clearUpdateBadge(),e({success:!0})}catch(s){e({success:!1,error:s instanceof Error?s.message:String(s)})}return!0;case"DISMISS_UPDATE":try{await this.dismissUpdate(t.version),e({success:!0})}catch(s){e({success:!1,error:s instanceof Error?s.message:String(s)})}return!0;case"GET_UPDATE_INFO":try{const s=await this.getStoredUpdateInfo();e(s)}catch{e(null)}return!0;default:return!1}}setupNotificationListeners(){var t,e,s,r;(e=(t=a.notifications)==null?void 0:t.onClicked)==null||e.addListener(n=>{n.startsWith("update-available")&&this.handleNotificationClick(n)}),(r=(s=a.notifications)==null?void 0:s.onButtonClicked)==null||r.addListener((n,o)=>{n.startsWith("update-available")&&this.handleNotificationButtonClick(n,o)})}async checkForUpdates(t=!1){try{const e=await fetch(this.githubApiUrl,{headers:{Accept:"application/vnd.github+json","User-Agent":"side-translation"},cache:"no-cache"});if(!e.ok){const m=await e.text();throw console.error("[UpdateCheckService] GitHub API é”™è¯¯å“åº”:",m),new Error(`GitHub API è¯·æ±‚å¤±è´¥: ${e.status} - ${m.slice(0,100)}`)}const s=await e.json();if(s.prerelease||s.draft)return this.createUpdateInfo(!1,this.currentVersion);const r=s.tag_name.replace(/^v/,""),n=this.compareVersions(r,this.currentVersion)>0,o=this.parseDownloadAssets(s.assets||[]),d={hasUpdate:n,latestVersion:r,currentVersion:this.currentVersion,releaseNotes:s.body,downloadUrl:s.html_url,releaseDate:s.published_at,downloadAssets:o};return n?await this.handleUpdateAvailable(d,t):await this.setBadge(!1),await this.storeUpdateInfo(d),d}catch(e){return console.error("[UpdateCheckService] æ£€æŸ¥æ›´æ–°å¤±è´¥:",e),this.createUpdateInfo(!1,this.currentVersion)}}async handleUpdateAvailable(t,e=!1){const s=await this.getLastNotifiedVersion(),r=e?!1:await this.isUpdateDismissed(t.latestVersion);s!==t.latestVersion&&!r&&(await this.showUpdateNotification(t),await this.setLastNotifiedVersion(t.latestVersion)),r||await this.setBadge(!0)}async showUpdateNotification(t){try{const e=`update-available-${t.latestVersion}`;await a.notifications.create(e,{type:"basic",iconUrl:"/icon/128.png",title:"ğŸ‰ Side Translation æœ‰æ–°ç‰ˆæœ¬äº†ï¼",message:`å‘ç°æ–°ç‰ˆæœ¬ v${t.latestVersion}ï¼Œå½“å‰ç‰ˆæœ¬ v${t.currentVersion}ã€‚ç‚¹å‡»æŸ¥çœ‹æ›´æ–°è¯¦æƒ…ã€‚`,buttons:[{title:"æŸ¥çœ‹æ›´æ–°"},{title:"ç¨åæé†’"}]})}catch(e){console.error("[UpdateCheckService] æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:",e)}}async handleNotificationClick(t){const e=await this.getStoredUpdateInfo();e!=null&&e.downloadUrl&&a.tabs.create({url:e.downloadUrl}),a.notifications.clear(t)}async handleNotificationButtonClick(t,e){const s=await this.getStoredUpdateInfo();e===0&&(s!=null&&s.downloadUrl)&&a.tabs.create({url:s.downloadUrl}),a.notifications.clear(t)}async setBadge(t){try{t?(await a.action.setBadgeText({text:"NEW"}),await a.action.setBadgeBackgroundColor({color:"#ff4444"}),await a.action.setTitle({title:"Side Translation - æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"})):(await a.action.setBadgeText({text:""}),await a.action.setTitle({title:"Side Translation"}))}catch(e){console.error("[UpdateCheckService] è®¾ç½®å¾½ç« å¤±è´¥:",e)}}async clearUpdateBadge(){await this.setBadge(!1);const t=await this.getStoredUpdateInfo();t!=null&&t.latestVersion&&await this.dismissUpdate(t.latestVersion)}async dismissUpdate(t){const e=await this.getDismissedVersions();e.includes(t)||(e.push(t),await a.storage.local.set({dismissedUpdateVersions:e}))}compareVersions(t,e){const s=t.split(".").map(Number),r=e.split(".").map(Number),n=Math.max(s.length,r.length);for(let o=0;o<n;o++){const d=s[o]||0,m=r[o]||0;if(d>m)return 1;if(d<m)return-1}return 0}createUpdateInfo(t,e){return{hasUpdate:t,latestVersion:e,currentVersion:this.currentVersion}}async storeUpdateInfo(t){await a.storage.local.set({updateInfo:t,lastUpdateCheck:Date.now()})}async getStoredUpdateInfo(){return(await a.storage.local.get("updateInfo")).updateInfo||null}async checkPendingUpdate(){const t=await this.getStoredUpdateInfo();t!=null&&t.hasUpdate&&(await this.isUpdateDismissed(t.latestVersion)||await this.setBadge(!0))}async getLastNotifiedVersion(){return(await a.storage.local.get("lastNotifiedVersion")).lastNotifiedVersion||null}async setLastNotifiedVersion(t){await a.storage.local.set({lastNotifiedVersion:t})}async getDismissedVersions(){return(await a.storage.local.get("dismissedUpdateVersions")).dismissedUpdateVersions||[]}async isUpdateDismissed(t){return(await this.getDismissedVersions()).includes(t)}parseDownloadAssets(t){const e=[];for(const s of t){let r;const n=s.name.toLowerCase();n.includes("chrome")||n.includes(".crx")?r="chrome":n.includes("firefox")||n.includes(".xpi")?r="firefox":n.includes("edge")?r="edge":n.includes("safari")&&(r="safari"),e.push({name:s.name,downloadUrl:s.browser_download_url,size:s.size,browserType:r})}return e}};g($,"instance");let ot=$;var bt=(i=>(i.SETTINGS_UPDATED="settings_updated",i.WEBSITE_MANAGEMENT_UPDATED="website_management_updated",i.CONTEXT_MENU_ACTION="context-menu-action",i.NOTIFICATION="notification",i.ERROR="error",i))(bt||{});const C={tokenRefreshThreshold:600,tokenCheckInterval:120,maxRetryCount:3,retryDelay:1e3,authEndpoint:"https://side-translation.planktonfly.com/auth_token",apiBaseUrl:"https://side-translation.planktonfly.com/api",clientSecret:"Gp8kL4mX9nQ2wR7tY5vZ3bN6hJ1sA0cF"},Xt=C.clientSecret;function Zt(i,t){const e=t.toString().slice(0,-2),s=`${i}|${e}`;return vt(s,Xt).then(r=>r.substring(0,32))}function te(i=16){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=new Uint8Array(i);return crypto.getRandomValues(e),Array.from(e,s=>t[s%t.length]).join("")}function Nt(i){if(i instanceof URLSearchParams){const t=[];return i.forEach((e,s)=>{t.push([s,e])}),t}if(typeof i=="string")return Nt(new URLSearchParams(i));if(i&&typeof i=="object"){const t=i.forEach;if(typeof t=="function"){const s=[];if(t.call(i,(r,n)=>{s.push([String(n),String(r??"")])}),s.length>0)return s}const e=i.entries;if(typeof e=="function"){const s=e.call(i);if(s&&Symbol.iterator in Object(s))return Array.from(s).map(([r,n])=>[String(r),String(n??"")])}return Object.entries(i).map(([s,r])=>[s,String(r??"")])}return[]}function ee(i){return Nt(i).sort((e,s)=>{const r=e[0].localeCompare(s[0]);return r!==0?r:e[1].localeCompare(s[1])}).map(([e,s])=>`${e}=${s}`).join("&")}async function se(i){const t=new TextEncoder().encode(i),e=await crypto.subtle.digest("SHA-256",t);return kt(e)}async function vt(i,t){const e=new TextEncoder().encode(t),s=new TextEncoder().encode(i),r=await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),n=await crypto.subtle.sign("HMAC",r,s);return kt(n)}function kt(i){return Array.from(new Uint8Array(i)).map(t=>t.toString(16).padStart(2,"0")).join("")}const ie="ws://192.168.8.145:3000/log-ws",re=2e3,ne=5,ae=1200;function z(i,t=ae){return i.length<=t?i:`${i.slice(0,t)}...<truncated>`}function _t(i){return{type:"Error",name:i.name,message:i.message,stack:i.stack?z(i.stack,2e3):void 0}}function Q(i){const t=new WeakSet;try{return JSON.stringify(i,(e,s)=>{if(s instanceof Error)return _t(s);if(typeof s=="bigint")return s.toString();if(s&&typeof s=="object"){const r=s;if(t.has(r))return"[Circular]";t.add(r)}return s},2)}catch{return String(i)}}function oe(i){return i instanceof Error?z(Q(_t(i))):i instanceof Response?z(Q({type:"Response",url:i.url,ok:i.ok,status:i.status,statusText:i.statusText,redirected:i.redirected})):i instanceof Request?z(Q({type:"Request",url:i.url,method:i.method,mode:i.mode,credentials:i.credentials})):z(typeof i=="object"&&i!==null?Q(i):String(i))}let N=null,H=!1,ct=0,X=null,Z=!1;function ce(){return new Date().toISOString()}function le(i){if(i.length!==0)return i.map(t=>oe(t)).join(" ")}function ue(i){if(N&&N.readyState===WebSocket.OPEN)try{N.send(JSON.stringify(i))}catch{}}function Ut(){if(!(Z||H||N&&N.readyState===WebSocket.OPEN)){H=!0;try{N=new WebSocket(ie),N.onopen=()=>{H=!1,ct=0},N.onclose=i=>{H=!1,N=null,xt()},N.onerror=()=>{H=!1},N.onmessage=i=>{}}catch{H=!1,xt()}}}function xt(){if(!Z){if(ct++,ct>=ne){Z=!0;return}X&&clearTimeout(X),X=setTimeout(()=>{X=null,Ut()},re)}}function de(){if(typeof WebSocket>"u"){Z=!0;return}Ut()}function lt(i,t,e,...s){const r=le(s),n=i==="error"?"error":i==="warn"?"warn":"log",o=i==="error"?"âŒ ":i==="warn"?"âš ï¸ ":"";console[n](`[${t}] ${o}${e}`,...s);const d={timestamp:ce(),level:i,module:t,message:e,args:r};ue(d)}function Dt(i){return{log:(t,...e)=>lt("log",i,t,...e),warn:(t,...e)=>lt("warn",i,t,...e),error:(t,...e)=>lt("error",i,t,...e)}}typeof window<"u"&&de();class he{constructor(){g(this,"state",null);g(this,"refreshPromise",null);g(this,"initialized",!1);g(this,"hasAlarmCapability",!1)}async init(){if(this.initialized)return;const t=await chrome.storage.local.get(["authState","tempId","userId","authUser"]);if(t.authState&&(this.state=t.authState),!this.normalizeUserId(t.userId)){const s=this.deriveUserIdFromAuthUser(t.authUser);s&&(await chrome.storage.local.set({userId:s}),I.log("Migrated userId from authUser profile",{migratedUserId:s}))}if(!t.tempId){const s=crypto.randomUUID();await chrome.storage.local.set({tempId:s})}this.hasAlarmCapability=this.canUseAlarmApi(),this.initialized=!0,this.startCheckLoop()}async getValidToken(){var o;await this.init();const t=Date.now(),e=await chrome.storage.local.get("userId"),s=this.normalizeUserId(e.userId),r=this.normalizeUserId((o=this.state)==null?void 0:o.userId);return!!this.state&&s!==r?(I.log("Auth identity changed, forcing token refresh",{previousUserId:r||null,currentUserId:s||null}),await this.refreshToken(!0)):!this.state||t>=this.state.expiryTime?await this.refreshToken():t>=this.state.expiryTime-C.tokenRefreshThreshold*1e3&&this.refreshToken().catch(d=>{I.warn("Background token refresh failed",d)}),this.state.token}async refreshToken(t=!1){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this._doRefreshWithFallback(t);try{return await this.refreshPromise}finally{this.refreshPromise=null}}async _doRefreshWithFallback(t){try{return await this._doRefresh(t)}catch(e){if(!this.shouldFallbackToForceNew(e,t))throw e;I.warn("token_refresh_fallback_start",{reason:"token_revoked_or_expired",strategy:"retry_with_init_salt"});try{const s=await this._doRefresh(!0);return I.log("token_refresh_fallback_success",{strategy:"retry_with_init_salt"}),s}catch(s){throw I.error("token_refresh_fallback_failed",{strategy:"retry_with_init_salt",error:s instanceof Error?s.message:String(s)}),s}}}shouldFallbackToForceNew(t,e){var n;if(e||!((n=this.state)!=null&&n.token)||!(t instanceof Error))return!1;const s=t,r=/token revoked or expired/i.test(t.message);return s.status===401&&r}async _doRefresh(t){var y,h;const e=await chrome.storage.local.get(["tempId","userId"]),s=e.tempId,r=this.normalizeUserId(e.userId),n=Math.floor(Date.now()/1e3).toString(),o=chrome.runtime.id,d=chrome.runtime.getManifest().version.replace(/\./g,""),m={"Content-Type":"application/json","x-temp-id":s,"x-extension-id":o,"x-extension-version":d,"x-timestamp":n,"x-user-id":r};(y=this.state)!=null&&y.token&&!t?m.Authorization=`Bearer ${this.state.token}`:m["x-init-salt"]=await Zt(o,parseInt(n)),I.log("Refreshing token",{endpoint:C.authEndpoint,extensionId:o,extensionVersion:d,hasTempId:!!s,forceNew:t,hasOldToken:!!((h=this.state)!=null&&h.token&&!t),hasUserId:!!r});const f=await fetch(C.authEndpoint,{method:"POST",headers:m});if(!f.ok){const S=await f.text().catch(()=>"");let k=`Auth failed: ${f.status}`;try{k=JSON.parse(S).error||k}catch{S&&(k=S.slice(0,200))}I.error("Token refresh failed",{endpoint:C.authEndpoint,extensionId:o,extensionVersion:d,hasTempId:!!s,hasUserId:!!r,status:f.status,statusText:f.statusText,message:k,bodySnippet:S.slice(0,500)});const K=new Error(k);throw K.status=f.status,K}const p=await f.json();return this.state={token:p.token,expiryTime:Date.now()+p.expires_in*1e3,checkInterval:p.check_interval||C.tokenCheckInterval,userId:r},await chrome.storage.local.set({authState:this.state}),I.log("Token refresh succeeded",{expiresInSeconds:p.expires_in,checkInterval:p.check_interval,hasUserId:!!r}),this.state}startCheckLoop(){if(!this.hasAlarmCapability){I.log("Alarm API unavailable in current context, skip tokenCheck");return}try{chrome.alarms.create("tokenCheck",{periodInMinutes:C.tokenCheckInterval/60})}catch(t){I.warn("Failed to create tokenCheck alarm",t)}}async handleAlarm(){if(await this.init(),!this.state)return;const t=Date.now(),e=C.tokenRefreshThreshold*1e3;if(t>=this.state.expiryTime-e)try{await this.refreshToken(),I.log("Token refreshed by alarm")}catch(s){I.error("Alarm token refresh failed",s)}}async onLoginSuccess(t){const e=this.normalizeUserId(t);await chrome.storage.local.set({userId:e}),await this.refreshToken(!0)}async onLogout(){this.state=null,await chrome.storage.local.remove(["authState","userId"]),await this.refreshToken(!0)}async checkAndRefreshIfNeeded(){if(await this.init(),!this.state){await this.refreshToken(!0);return}const t=Date.now(),e=C.tokenRefreshThreshold*1e3;t>=this.state.expiryTime-e&&await this.refreshToken()}canUseAlarmApi(){try{return typeof chrome<"u"&&!!chrome.alarms&&typeof chrome.alarms.create=="function"}catch{return!1}}normalizeUserId(t){return typeof t=="string"?t.trim():""}deriveUserIdFromAuthUser(t){if(!t||typeof t!="object")return"";const e=t,s=[e.email,e.username,e.displayName];for(const r of s){const n=this.normalizeUserId(r);if(n)return n}return""}}const I=Dt("AuthManager"),T=new he,D=Dt("RequestInterceptor"),fe="https://side-translation.planktonfly.com";function tt(i){return i instanceof Error?{name:i.name,message:i.message,stack:i.stack}:{value:String(i)}}function ge(i){return i.includes("/translate_tts")||i.includes("/translate_a/single")}class me{constructor(){g(this,"tempId",null);g(this,"extensionId");g(this,"extensionVersion");this.extensionId=chrome.runtime.id,this.extensionVersion=chrome.runtime.getManifest().version.replace(/\./g,"")}async init(){if(this.tempId)return;const t=await chrome.storage.local.get("tempId");this.tempId=t.tempId}async fetch(t,e={},s=0){if(await this.init(),await T.init(),!this.tempId){const h=await chrome.storage.local.get("tempId");this.tempId=h.tempId||null}const r=e.method||"GET";let n=t;try{n=this.resolveUrl(t)}catch(h){throw D.error("Failed to resolve request URL",{url:t,method:r,retryCount:s,error:tt(h)}),h}let o="";try{o=await T.getValidToken()}catch(h){throw D.error("Failed to get valid token",{url:n,method:r,retryCount:s,error:tt(h)}),h}const d=Math.floor(Date.now()/1e3).toString(),m=te(16);let f="";try{f=await this.calculateSign(r,n,e.body,d,o)}catch(h){throw D.error("Failed to calculate request signature",{url:n,method:r,retryCount:s,error:tt(h)}),h}const p={...e.headers||{},Authorization:`Bearer ${o}`,"x-user-id":(await chrome.storage.local.get("userId")).userId||"","x-temp-id":this.tempId||"","x-timestamp":d,"x-nonce":m,"x-extension-id":this.extensionId,"x-extension-version":this.extensionVersion,"x-sign":f};this.tempId||D.warn("Missing tempId in request headers",{url:n,method:r,retryCount:s}),e.body&&typeof e.body=="object"&&(p["Content-Type"]="application/json",e.body=JSON.stringify(e.body));const y=ge(n);y&&D.log("Request start",{url:n,rawUrl:t,method:r,retryCount:s,hasUserId:!!p["x-user-id"],hasTempId:!!p["x-temp-id"]});try{const h=await fetch(n,{...e,headers:p});if(y&&!h.ok){const S=await h.clone().text().then(k=>k.slice(0,500)).catch(()=>"");D.warn("Request returned non-OK status",{url:n,method:r,retryCount:s,status:h.status,statusText:h.statusText,bodySnippet:S})}if(h.status===401&&s<C.maxRetryCount){const S=await h.clone().json().catch(()=>({}));if(D.warn("Received 401 response",{url:n,method:r,retryCount:s,action:S.action||""}),S.action==="refresh_token")return await T.refreshToken(),this.fetch(t,e,s+1)}return h}catch(h){if(D.error("Request failed",{url:n,method:r,retryCount:s,error:tt(h)}),s<C.maxRetryCount)return await this.delay(C.retryDelay*(s+1)),this.fetch(t,e,s+1);throw h}}async calculateSign(t,e,s,r,n){let o;const d=this.tempId||"";if(t==="GET"){const m=new URL(e);o=`${ee(m.searchParams)}|${r}|${d}`}else{const m=typeof s=="string"?s:JSON.stringify(s||{});o=`${await se(m)}|${r}|${d}`}return vt(o,n)}resolveUrl(t){return/^https?:\/\//i.test(t)?t:new URL(t,fe).toString()}async get(t,e={}){return this.fetch(t,{...e,method:"GET"})}async post(t,e,s={}){return this.fetch(t,{...s,method:"POST",body:e})}async put(t,e,s={}){return this.fetch(t,{...s,method:"PUT",body:e})}async delete(t,e={}){return this.fetch(t,{...e,method:"DELETE"})}delay(t){return new Promise(e=>setTimeout(e,t))}}new me;const v=class v{async setSystemSelectionBannerDisabled(t){if(!this.isNativeMessagingAvailable())return{ok:!1,supported:!1,disabled:t,error:"native_messaging_unavailable"};try{const e=await this.sendNativeMessage({type:v.TYPE_SET,disabled:t}),s=(e==null?void 0:e.ok)===!0;return{ok:s,supported:!0,disabled:typeof(e==null?void 0:e.disabled)=="boolean"?e.disabled:t,error:s||typeof(e==null?void 0:e.error)!="string"?void 0:e.error}}catch(e){return{ok:!1,supported:!1,disabled:t,error:e instanceof Error?e.message:String(e)}}}async getSystemSelectionBannerDisabled(){if(!this.isNativeMessagingAvailable())return{ok:!1,supported:!1,error:"native_messaging_unavailable"};try{const t=await this.sendNativeMessage({type:v.TYPE_GET}),e=(t==null?void 0:t.ok)===!0;return{ok:e,supported:!0,disabled:typeof(t==null?void 0:t.disabled)=="boolean"?t.disabled:void 0,error:e||typeof(t==null?void 0:t.error)!="string"?void 0:t.error}}catch(t){return{ok:!1,supported:!1,error:t instanceof Error?t.message:String(t)}}}isNativeMessagingAvailable(){return typeof a.runtime.connectNative=="function"||typeof a.runtime.sendNativeMessage=="function"}async sendNativeMessage(t){if(typeof a.runtime.connectNative=="function")try{return await this.sendViaConnectNative(t)}catch{}const s=a.runtime.sendNativeMessage;if(typeof s!="function")throw new Error("native_messaging_unavailable");return await s(v.HOST_NAME,t)}async sendViaConnectNative(t){const e=a.runtime.connectNative(v.HOST_NAME);return await new Promise((s,r)=>{let n=!1;const o=()=>{e.onMessage.removeListener(p),e.onDisconnect.removeListener(y)},d=h=>{if(!n){n=!0,o();try{e.disconnect()}catch{}s(h)}},m=h=>{if(!n){n=!0,o();try{e.disconnect()}catch{}r(h)}},f=setTimeout(()=>{m(new Error("native_messaging_timeout"))},v.NATIVE_CALL_TIMEOUT_MS),p=h=>{if(clearTimeout(f),h&&typeof h=="object"){d(h);return}d(void 0)},y=()=>{var S;if(n)return;clearTimeout(f);const h=typeof((S=a.runtime.lastError)==null?void 0:S.message)=="string"?a.runtime.lastError.message:"native_messaging_disconnected";m(new Error(h))};e.onMessage.addListener(p),e.onDisconnect.addListener(y);try{e.postMessage(t)}catch(h){clearTimeout(f),m(h instanceof Error?h:new Error(String(h)))}})}};g(v,"HOST_NAME","linguasurfAppBridge"),g(v,"TYPE_SET","SET_SELECTION_BANNER_DISABLED"),g(v,"TYPE_GET","GET_SELECTION_BANNER_DISABLED"),g(v,"NATIVE_CALL_TIMEOUT_MS",3e3);let ut=v;const pe=V(()=>{const i="user_settings",e=a.runtime.getManifest().version,s=a.runtime.id;console.info("[Background] Extension startup",{version:e,extensionId:s,context:"service_worker_boot"});const r=G.getInstance(),n=st.getInstance(),o=it.getInstance(),d=rt.getInstance(),m=at.getInstance(),f=ot.getInstance(),p=new ut;async function y(){try{await T.init(),d.initialize(),await f.init(),await m.initializeRuntime();const c=await r.getUserSettings();await ft(c,"startup")}catch(c){console.error("[Background] æœåŠ¡åˆå§‹åŒ–å¤±è´¥:",c)}}a.runtime.onInstalled.addListener(async c=>{try{const u=await m.handleInstallation(c);u.success?u.warnings.length>0:console.error("[Background] å®‰è£…å¤„ç†å¤±è´¥:",u.errors),await T.checkAndRefreshIfNeeded()}catch(u){console.error("[Background] å®‰è£…å¤„ç†å¼‚å¸¸:",u)}}),a.runtime.onStartup.addListener(async()=>{await T.checkAndRefreshIfNeeded()}),a.storage.onChanged.addListener((c,u)=>{if(u!=="sync"&&u!=="local")return;const l=c[i];if(!l||typeof l.newValue>"u")return;const E=Ee(l.newValue);E&&ft(E).catch(B=>{})}),chrome.alarms.onAlarm.addListener(async c=>{c.name==="tokenCheck"&&await T.handleAlarm()}),chrome.idle.onStateChanged.addListener(async c=>{c==="active"&&await T.checkAndRefreshIfNeeded()}),a.runtime.onMessage.addListener((c,u,l)=>{switch(c.type){case x.SHOW_NOTIFICATION:return h(c),!1;case x.OPEN_POPUP:return S(),!1;case x.OPEN_OPTIONS:return k(c),!1;case x.VALIDATE_CONFIG:return K(c,l),!0;case x.API_REQUEST:return R(c,l),!0;case bt.CONTEXT_MENU_ACTION:return ht(c,l),!0;case x.SETTINGS_UPDATED:case x.API_CONFIG_UPDATED:return ye(c,l),!0;case x.SET_SELECTION_BANNER_DISABLED:return Se(c,l),!0;case"CHECK_UPDATE":case"CLEAR_UPDATE_BADGE":case"DISMISS_UPDATE":case"GET_UPDATE_INFO":return Ie(c,l),!0;case"GET_TOKEN":return Te(l),!0;case"LOGIN_SUCCESS":return Ae(c,l),!0;case"LOGOUT":return Ce(l),!0;case"GET_AUTH_STATE":return be(l),!0;default:return!1}});async function h(c){try{await n.showNotification({type:"basic",title:c.options.title||"é€šçŸ¥",message:c.options.message||"",iconUrl:c.options.iconUrl})}catch(u){console.error("[Background] æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:",u)}}async function S(){try{a.action.openPopup()}catch(c){console.error("[Background] æ— æ³•æ‰“å¼€popup:",c);const u=a.runtime.getURL(b.OPTIONS_PATH);a.tabs.create({url:u})}}async function k(c){let u=a.runtime.getURL(b.OPTIONS_PATH);c!=null&&c.hash&&(u+=c.hash),a.tabs.create({url:u})}function K(c,u){(async()=>{var l,E;try{const B=await r.getUserSettings(),F=(l=B.apiConfigs)==null?void 0:l.find(Ne=>Ne.id===B.activeApiConfigId);if(!!((E=F==null?void 0:F.config)!=null&&E.apiKey)){u(!0);return}await n.showApiConfigError(c.source),u(!1)}catch(B){console.error("[Background] é…ç½®éªŒè¯å¤±è´¥:",B),u(!1)}})()}function R(c,u){(async()=>{try{const l=await o.handleApiRequest(c);u(l)}catch(l){console.error("[Background] APIè¯·æ±‚å¤„ç†å¤±è´¥:",l),u({success:!1,error:{message:l instanceof Error?l.message:"æœªçŸ¥é”™è¯¯"}})}})()}function ht(c,u){(async()=>{try{u({success:!0,message:"å³é”®èœå•åŠ¨ä½œå·²å¤„ç†"})}catch(l){console.error("[Background] å³é”®èœå•åŠ¨ä½œå¤„ç†å¤±è´¥:",l),u({success:!1,error:{message:l instanceof Error?l.message:"æœªçŸ¥é”™è¯¯"}})}})()}function ye(c,u){(async()=>{try{const l=await a.tabs.query({});let E=0,B=null;await Promise.all(l.filter(F=>typeof F.id=="number").map(async F=>{try{await a.tabs.sendMessage(F.id,c),E+=1}catch{}})),c!=null&&c.settings&&(B=await ft(c.settings,"settings_updated")),u({success:!0,delivered:E,totalTabs:l.length,appControlResult:B})}catch(l){console.error("[Background] è®¾ç½®æ›´æ–°è½¬å‘å¤±è´¥:",l),u({success:!1,error:l instanceof Error?l.message:"æœªçŸ¥é”™è¯¯"})}})()}function Se(c,u){(async()=>{try{const l=!!(c!=null&&c.disabled),E=await p.setSystemSelectionBannerDisabled(l);E.ok,u({success:E.ok,result:E})}catch(l){const E=l instanceof Error?l.message:String(l);u({success:!1,error:E})}})()}async function ft(c,u){try{const l=await p.setSystemSelectionBannerDisabled(!!c.disableSystemSelectionBanner);return l.ok,l}catch(l){return{ok:!1,supported:!1,error:l instanceof Error?l.message:String(l)}}}function Ee(c){try{return typeof c=="string"?JSON.parse(c):c&&typeof c=="object"?c:null}catch{return null}}function Ie(c,u){(async()=>{try{await f.handleMessage(c,u)||u({success:!1,error:{message:"æœªçŸ¥çš„æ›´æ–°æ¶ˆæ¯ç±»å‹"}})}catch(l){console.error("[Background] æ›´æ–°æ¶ˆæ¯å¤„ç†å¤±è´¥:",l),u({success:!1,error:{message:l instanceof Error?l.message:"æœªçŸ¥é”™è¯¯"}})}})()}function Te(c){(async()=>{try{await T.init();const u=await T.getValidToken();c({token:u})}catch(u){c({error:u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯"})}})()}function Ae(c,u){(async()=>{try{await T.onLoginSuccess(c.userId),u({success:!0})}catch(l){u({success:!1,error:l instanceof Error?l.message:"æœªçŸ¥é”™è¯¯"})}})()}function Ce(c){(async()=>{try{await T.onLogout(),c({success:!0})}catch(u){c({success:!1,error:u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯"})}})()}function be(c){(async()=>{try{await T.init();const u=await chrome.storage.local.get("authState");c({state:u.authState||null})}catch(u){c({error:u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯"})}})()}y()});function _e(){}function et(i,...t){}const we={debug:(...i)=>et(console.debug,...i),log:(...i)=>et(console.log,...i),warn:(...i)=>et(console.warn,...i),error:(...i)=>et(console.error,...i)};let dt;try{dt=pe.main(),dt instanceof Promise}catch(i){throw we.error("The background crashed on startup!"),i}return dt}();
background;
