var background=function(){"use strict";var we=Object.defineProperty;var ye=(L,v,n)=>v in L?we(L,v,{enumerable:!0,configurable:!0,writable:!0,value:n}):L[v]=n;var h=(L,v,n)=>ye(L,typeof v!="symbol"?v+"":v,n);var Ut,_t;function L(i){return i==null||typeof i=="function"?{main:i}:i}const n=(_t=(Ut=globalThis.browser)==null?void 0:Ut.runtime)!=null&&_t.id?globalThis.browser:globalThis.chrome;var dt=(i=>(i[i.A1=1]="A1",i[i.A2=2]="A2",i[i.B1=3]="B1",i[i.B2=4]="B2",i[i.C1=5]="C1",i[i.C2=6]="C2",i))(dt||{}),ht=(i=>(i.DEFAULT="default",i.SUBTLE="subtle",i.BOLD="bold",i.ITALIC="italic",i.UNDERLINED="underlined",i.HIGHLIGHTED="highlighted",i.DOTTED="dotted",i.LEARNING="learning",i.CUSTOM="custom",i))(ht||{}),ft=(i=>(i.AUTOMATIC="automatic",i.MANUAL="manual",i))(ft||{}),gt=(i=>(i[i.VISIBLE=0]="VISIBLE",i[i.LEARNING=1]="LEARNING",i[i.HIDDEN=2]="HIDDEN",i))(gt||{}),mt=(i=>(i.BEFORE="before",i.AFTER="after",i))(mt||{}),pt=(i=>(i.WORD="word",i.PARAGRAPH="paragraph",i))(pt||{}),wt=(i=>(i.HOVER="hover",i.CLICK="click",i))(wt||{}),yt=(i=>(i.AUTO="auto",i.BUTTON="button",i.SWIPE="swipe",i))(yt||{});const Dt={apiKey:"YXBpLTEyMzQ1Ng==",apiEndpoint:"https://side-translation.planktonfly.com/v1/chat/completions",model:"gemini-3-flash-preview",temperature:parseFloat("0.2")||0,enable_thinking:!1,includeThinkingParam:!1,customParams:"",phraseEnabled:!0,requestsPerSecond:0,useBackgroundProxy:!1},Ot={nativeLanguage:"zh",targetLanguage:"en"},Pt={enabled:!0,modifierKeys:[],description:"å¿«æ·é”®"},Mt={enabled:!0,position:50,opacity:.8},Lt={enabled:!0,preloadDistance:1},Rt={enabled:!0,apiEndpoint:"https://side-translation.planktonfly.com/wordcard",selectCaptureMode:!0,dbClickCaptureMode:!1,singleClickCaptureMode:!1,showExplainIcon:!1,autoSpeak:!0,showEnglishDefinition:!0};function Vt(){return{id:"default-config",name:"defaultConfig",provider:"openai",config:Dt,isDefault:!0,createdAt:Date.now(),updatedAt:Date.now()}}const p={userLevel:dt.B1,replacementRate:.3,isEnabled:!0,useGptApi:!0,apiConfigs:[Vt()],activeApiConfigId:"default-config",translationStyle:ht.DEFAULT,translationMode:pt.WORD,triggerMode:ft.MANUAL,maxLength:2e3,minLength:80,originalWordDisplayMode:gt.VISIBLE,enablePronunciationTooltip:!0,multilingualConfig:Ot,pronunciationHotkey:Pt,floatingBall:Mt,translationPosition:mt.AFTER,showParentheses:!0,apiRequestTimeout:0,customTranslationCSS:"",lazyLoading:Lt,ttsProvider:"google",pronunciationTriggerMode:wt.CLICK,translationTriggerMode:yt.AUTO,showDebugPanel:!0,enableFullTextTTSBar:!0,enableWordLevelAnimation:!0,fullTextTTSBarCollapsed:!0,fullTextTTSConfigs:[{id:"default-tts-config",name:"Google Cloud TTS",config:{apiEndpoint:"https://texttospeech.googleapis.com/v1beta1/text:synthesize",apiKey:"AIzaSyCJV_CLwIhqiRI-5DobQZ7_YCc9i235m1Y",customParams:""},createdAt:Date.now(),updatedAt:Date.now()}],activeFullTextTTSConfigId:"default-tts-config",fullTextTTSVoiceName:"en-US-Chirp3-HD-Erinome",wordCard:Rt,paragraphTTS:{enabled:!0},gestureTranslation:{leftSwipe:!0,rightSwipe:!0}};class $t{async get(t){return(await n.storage.sync.get(t))[t]}async set(t,e){await n.storage.sync.set({[t]:e})}async remove(t){await n.storage.sync.remove(t)}}const Gt=new $t;var S=(i=>(i.SETTINGS_LOADED="settings_loaded",i.SETTINGS_SAVED="settings_saved",i.API_CONFIG_ADDED="api_config_added",i.API_CONFIG_UPDATED="api_config_updated",i.API_CONFIG_REMOVED="api_config_removed",i.ACTIVE_CONFIG_CHANGED="active_config_changed",i.DATA_CLEARED="data_cleared",i))(S||{});const N=class N{constructor(t={}){h(this,"config");h(this,"storageKey");h(this,"settingsStoragePort");h(this,"eventListeners",new Map);this.config={enableAutoBackup:!0,enableValidation:!0,maxRetries:3,storageKey:"user_settings",...t},this.storageKey=this.config.storageKey,this.settingsStoragePort=this.config.settingsStoragePort||Gt}static getInstance(t){return N.instance||(N.instance=new N(t)),N.instance}addEventListener(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}removeEventListener(t,e){const s=this.eventListeners.get(t);if(s){const a=s.indexOf(e);a>-1&&s.splice(a,1)}}emitEvent(t,e,s){const a={type:t,timestamp:Date.now(),data:e,error:s},r=this.eventListeners.get(t);r&&r.forEach(o=>{try{o(a)}catch(c){console.error("Storage event listener error:",c)}})}async getUserSettings(){try{const t=await this.settingsStoragePort.get(N.STORAGE_KEY);if(!t)return this.emitEvent(S.SETTINGS_LOADED,p),p;const e=JSON.parse(String(t));if(this.isOldFormatConfig(e))return await this.saveUserSettings(p),this.emitEvent(S.SETTINGS_LOADED,p),p;const s=this.validateAndFixSettings(e);return this.hasConfigurationChanged(e,s)&&await this.saveUserSettings(s),this.emitEvent(S.SETTINGS_LOADED,s),s}catch(t){const e=`è·å–ç”¨æˆ·è®¾ç½®å¤±è´¥: ${t}`;return console.error(e),this.emitEvent(S.SETTINGS_LOADED,p,e),p}}async saveUserSettings(t){try{this.config.enableValidation&&(t=this.validateAndFixSettings(t));const e=JSON.stringify(t);return await this.settingsStoragePort.set(this.storageKey,e),this.emitEvent(S.SETTINGS_SAVED,t),{success:!0,data:t}}catch(e){const s=`ä¿å­˜ç”¨æˆ·è®¾ç½®å¤±è´¥: ${e}`;return console.error(s),this.emitEvent(S.SETTINGS_SAVED,null,s),{success:!1,error:s}}}async getActiveApiConfig(){try{const t=await this.getUserSettings(),e=t.apiConfigs.find(s=>s.id===t.activeApiConfigId);return(e==null?void 0:e.config)||null}catch(t){return console.error("è·å–æ´»è·ƒAPIé…ç½®å¤±è´¥:",t),null}}async setActiveApiConfig(t){try{const e=await this.getUserSettings();if(!e.apiConfigs.some(r=>r.id===t)){const r=`APIé…ç½® ${t} ä¸å­˜åœ¨`;return console.error(r),{success:!1,error:r}}e.activeApiConfigId=t;const a=await this.saveUserSettings(e);return a.success&&this.emitEvent(S.ACTIVE_CONFIG_CHANGED,{configId:t}),a}catch(e){const s=`è®¾ç½®æ´»è·ƒAPIé…ç½®å¤±è´¥: ${e}`;return console.error(s),{success:!1,error:s}}}async addApiConfig(t,e,s){try{const a=await this.getUserSettings(),r=Date.now(),o={id:`config-${r}`,name:t,provider:e,config:s,isDefault:!1,createdAt:r,updatedAt:r};a.apiConfigs.push(o);const c=await this.saveUserSettings(a);return c.success?(this.emitEvent(S.API_CONFIG_ADDED,o),{success:!0,data:o.id}):c}catch(a){const r=`æ·»åŠ APIé…ç½®å¤±è´¥: ${a}`;return console.error(r),{success:!1,error:r}}}async updateApiConfig(t,e,s,a){try{const r=await this.getUserSettings(),o=r.apiConfigs.findIndex(f=>f.id===t);if(o===-1){const f=`APIé…ç½® ${t} ä¸å­˜åœ¨`;return console.error(f),{success:!1,error:f}}const c={...r.apiConfigs[o],name:e,provider:s,config:a,updatedAt:Date.now()};r.apiConfigs[o]=c;const g=await this.saveUserSettings(r);return g.success&&this.emitEvent(S.API_CONFIG_UPDATED,c),g}catch(r){const o=`æ›´æ–°APIé…ç½®å¤±è´¥: ${r}`;return console.error(o),{success:!1,error:o}}}async removeApiConfig(t){try{const e=await this.getUserSettings(),s=e.apiConfigs.find(r=>r.id===t);if(s!=null&&s.isDefault){const r="ä¸èƒ½åˆ é™¤é»˜è®¤é…ç½®";return console.error(r),{success:!1,error:r}}if(e.activeApiConfigId===t){const r=e.apiConfigs.find(o=>o.id!==t);r&&(e.activeApiConfigId=r.id)}e.apiConfigs=e.apiConfigs.filter(r=>r.id!==t);const a=await this.saveUserSettings(e);return a.success&&this.emitEvent(S.API_CONFIG_REMOVED,{configId:t}),a}catch(e){const s=`åˆ é™¤APIé…ç½®å¤±è´¥: ${e}`;return console.error(s),{success:!1,error:s}}}async clearAllData(){try{return await this.settingsStoragePort.remove(this.storageKey),this.emitEvent(S.DATA_CLEARED),{success:!0}}catch(t){const e=`æ¸…é™¤æ•°æ®å¤±è´¥: ${t}`;return console.error(e),{success:!1,error:e}}}async getConfigStats(){try{const t=await this.getUserSettings();return{intelligentModeEnabled:!0,targetLanguage:t.multilingualConfig.targetLanguage,totalKeys:Object.keys(t).length,apiConfigsCount:t.apiConfigs.length}}catch(t){return console.error("è·å–é…ç½®ç»Ÿè®¡å¤±è´¥:",t),{intelligentModeEnabled:!0,targetLanguage:"en",totalKeys:0,apiConfigsCount:0}}}isOldFormatConfig(t){const e=t.multilingualConfig;return e?"intelligentMode"in e||"enableNativeSwitch"in e||"sourceLanguageOverride"in e:!1}validateAndFixSettings(t){const e={...t};try{const s={...p,...e,multilingualConfig:{...p.multilingualConfig,...e.multilingualConfig||{}},pronunciationHotkey:{...p.pronunciationHotkey,...e.pronunciationHotkey||{}},floatingBall:{...p.floatingBall,...e.floatingBall||{}},lazyLoading:{...p.lazyLoading,...e.lazyLoading||{}},wordCard:{...p.wordCard,...e.wordCard||{}},paragraphTTS:{...p.paragraphTTS,...e.paragraphTTS||{}},gestureTranslation:{...p.gestureTranslation,...e.gestureTranslation||{}}};return s.apiConfigs||(s.apiConfigs=p.apiConfigs),s.activeApiConfigId||s.apiConfigs.length>0&&(s.activeApiConfigId=s.apiConfigs[0].id),s.activeApiConfigId&&!s.apiConfigs.some(r=>r.id===s.activeApiConfigId)&&s.apiConfigs.length>0&&(s.activeApiConfigId=s.apiConfigs[0].id),s.multilingualConfig||(s.multilingualConfig=p.multilingualConfig),s.lazyLoading||(s.lazyLoading=p.lazyLoading),s}catch(s){return console.error(`è®¾ç½®éªŒè¯å¼‚å¸¸: ${s}`),p}}hasConfigurationChanged(t,e){try{return JSON.stringify(t)!==JSON.stringify(e)}catch{return!0}}};h(N,"instance"),h(N,"STORAGE_KEY","user_settings");let R=N;R.getInstance();class Bt extends Error{constructor(t,e,s){super(t),this.code=e,this.context=s,this.name="BackgroundServiceError"}}class H extends Bt{constructor(t,e){super(t,"NOTIFICATION_ERROR",e),this.name="NotificationError"}}const T={NOTIFICATION_TIMEOUT:5e3,API_REQUEST_TIMEOUT:3e4,SESSION_KEY_API_NOTIFICATION:"apiKeyNotificationShown",MENU_PARENT_ID:"illa-website-management",WARNING_ICON_PATH:"/warning.png",OPTIONS_PATH:"/options.html"},V={SHOW_NOTIFICATION:"show-notification",OPEN_POPUP:"open-popup",OPEN_OPTIONS:"open-options",VALIDATE_CONFIG:"validate-configuration",API_REQUEST:"api-request",SETTINGS_UPDATED:"settings_updated",API_CONFIG_UPDATED:"api_config_updated"},It={TRANSLATE_PAGE:"translate-page"},U=class U{constructor(){h(this,"config");this.config={defaultIconUrl:T.WARNING_ICON_PATH,defaultTimeout:T.NOTIFICATION_TIMEOUT,sessionStorageKey:T.SESSION_KEY_API_NOTIFICATION}}static getInstance(){return U.instance||(U.instance=new U),U.instance}async showNotification(t){try{return await n.notifications.create({type:"basic",iconUrl:t.iconUrl||n.runtime.getURL("/warning.png"),title:t.title,message:t.message})||""}catch(e){throw console.error("åˆ›å»ºé€šçŸ¥å¤±è´¥:",e),new H(`åˆ›å»ºé€šçŸ¥å¤±è´¥: ${e instanceof Error?e.message:"æœªçŸ¥é”™è¯¯"}`,{notificationConfig:t})}}async showApiConfigError(t){const e={type:"basic",title:"[æµ¸å…¥å¼å­¦è¯­è¨€åŠ©æ‰‹] API é…ç½®é”™è¯¯",message:"API å¯†é’¥æœªè®¾ç½®ã€‚è¯·ç‚¹å‡»æ‰©å±•å›¾æ ‡è¿›å…¥è®¾ç½®é¡µé¢è¿›è¡Œé…ç½®ã€‚",iconUrl:n.runtime.getURL("/warning.png")};try{t==="user_action"?await this.showNotification(e):await this.hasShownSessionNotification()||(await this.showNotification(e),await this.markSessionNotificationShown())}catch(s){throw console.error("æ˜¾ç¤ºAPIé…ç½®é”™è¯¯é€šçŸ¥å¤±è´¥:",s),s}}async showSuccessNotification(t,e,s){return this.showNotification({type:"basic",title:t,message:e,iconUrl:s||n.runtime.getURL("/icon/48.png")})}async showErrorNotification(t,e,s){return this.showNotification({type:"basic",title:t,message:s?`${e}: ${s.message}`:e,iconUrl:n.runtime.getURL("/warning.png")})}async showWarningNotification(t,e){const s={type:"basic",title:t,message:e,iconUrl:n.runtime.getURL("/warning.png"),priority:1};return this.showNotification(s)}async showProgressNotification(t,e,s){const a={type:"progress",title:t,message:e,iconUrl:n.runtime.getURL("/icon/48.png"),priority:1,progress:Math.max(0,Math.min(100,s))};try{return await n.notifications.create(a)||""}catch(r){throw console.error("åˆ›å»ºè¿›åº¦é€šçŸ¥å¤±è´¥:",r),new H(`åˆ›å»ºè¿›åº¦é€šçŸ¥å¤±è´¥: ${r instanceof Error?r.message:"æœªçŸ¥é”™è¯¯"}`,{title:t,message:e,progress:s})}}async updateProgressNotification(t,e,s){try{const a={progress:Math.max(0,Math.min(100,e))};s&&(a.message=s),await n.notifications.update(t,a)}catch(a){throw console.error("æ›´æ–°è¿›åº¦é€šçŸ¥å¤±è´¥:",a),new H(`æ›´æ–°è¿›åº¦é€šçŸ¥å¤±è´¥: ${a instanceof Error?a.message:"æœªçŸ¥é”™è¯¯"}`,{notificationId:t,progress:e,message:s})}}async clearNotification(t){try{await n.notifications.clear(t)}catch(e){throw console.error("æ¸…é™¤é€šçŸ¥å¤±è´¥:",e),new H(`æ¸…é™¤é€šçŸ¥å¤±è´¥: ${e instanceof Error?e.message:"æœªçŸ¥é”™è¯¯"}`,{notificationId:t})}}async clearAllNotifications(){try{const t=await n.notifications.getAll(),e=Object.keys(t).map(s=>this.clearNotification(s));await Promise.all(e)}catch(t){throw console.error("æ¸…é™¤æ‰€æœ‰é€šçŸ¥å¤±è´¥:",t),new H(`æ¸…é™¤æ‰€æœ‰é€šçŸ¥å¤±è´¥: ${t instanceof Error?t.message:"æœªçŸ¥é”™è¯¯"}`)}}async hasShownSessionNotification(){try{return!!(await n.storage.session.get(this.config.sessionStorageKey))[this.config.sessionStorageKey]}catch(t){return console.error("æ£€æŸ¥ä¼šè¯é€šçŸ¥çŠ¶æ€å¤±è´¥:",t),!1}}async markSessionNotificationShown(){try{await n.storage.session.set({[this.config.sessionStorageKey]:!0})}catch(t){console.error("æ ‡è®°ä¼šè¯é€šçŸ¥çŠ¶æ€å¤±è´¥:",t)}}async resetSessionNotificationStatus(){try{await n.storage.session.remove(this.config.sessionStorageKey)}catch(t){console.error("é‡ç½®ä¼šè¯é€šçŸ¥çŠ¶æ€å¤±è´¥:",t)}}setNotificationClickListener(t){var e;(e=n.notifications)!=null&&e.onClicked&&n.notifications.onClicked.addListener(t)}setNotificationButtonClickListener(t){n.notifications.onButtonClicked&&n.notifications.onButtonClicked.addListener(t)}setNotificationCloseListener(t){var e;(e=n.notifications)!=null&&e.onClosed&&n.notifications.onClosed.addListener(t)}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}async checkNotificationPermission(){try{return n.notifications!==void 0}catch(t){return console.error("æ£€æŸ¥é€šçŸ¥æƒé™å¤±è´¥:",t),!1}}destroy(){U.instance=null}};h(U,"instance",null);let tt=U;const _=class _{constructor(){h(this,"config");h(this,"activeRequests",new Map);this.config={defaultTimeout:T.API_REQUEST_TIMEOUT,maxRetries:3,retryDelay:1e3}}static getInstance(){return _.instance||(_.instance=new _),_.instance}async handleApiRequest(t){const{url:e,method:s,headers:a,body:r,timeout:o}=t.data;let c;try{const g=new AbortController;o&&o>0&&(c=setTimeout(()=>g.abort(),o));const f=await fetch(e,{method:s,headers:a,body:r,signal:g.signal});c&&clearTimeout(c);const w=await f.text();let y;try{y=JSON.parse(w)}catch{y=w}return f.ok?{success:!0,data:y}:{success:!1,error:{message:`HTTP ${f.status}: ${f.statusText}`,status:f.status,statusText:f.statusText}}}catch(g){console.error("Background APIè¯·æ±‚å¤±è´¥:",g);let f="è¯·æ±‚å¤±è´¥";return g.name==="AbortError"?f="è¯·æ±‚è¶…æ—¶":g.message&&(f=g.message),{success:!1,error:{message:f}}}}cancelAllRequests(){this.activeRequests.forEach(t=>{t.abort()}),this.activeRequests.clear()}updateConfig(t){this.config={...this.config,...t}}destroy(){this.cancelAllRequests(),_.instance=null}};h(_,"instance",null);let et=_;const D=class D{constructor(){h(this,"config");h(this,"storageService");this.config={enabledCommands:["translate-page"],requiresValidation:!0},this.storageService=R.getInstance()}static getInstance(){return D.instance||(D.instance=new D),D.instance}initialize(){n.commands.onCommand.addListener(this.handleCommand.bind(this))}async handleCommand(t){if(this.isCommandEnabled(t))try{const e=await this.executeCommand(t);!e.success&&e.error&&console.error(`[CommandService] å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${e.error}`)}catch(e){console.error("[CommandService] å‘½ä»¤æ‰§è¡Œå¼‚å¸¸:",e)}}async executeCommand(t){switch(t){case It.TRANSLATE_PAGE:return this.handleTranslatePageCommand();default:return{success:!1,error:`æœªçŸ¥å‘½ä»¤: ${t}`}}}async handleTranslatePageCommand(){var t;try{if(this.config.requiresValidation&&!(await this.validateApiConfiguration()).isValid)return{success:!1,error:"APIé…ç½®æ— æ•ˆ"};const e=await n.tabs.query({active:!0,currentWindow:!0});return(t=e[0])!=null&&t.id?(await n.tabs.sendMessage(e[0].id,{type:"translate-page-command"}),{success:!0}):{success:!1,error:"æ— æ³•è·å–å½“å‰æ ‡ç­¾é¡µ"}}catch(e){return console.error("[CommandService] ç¿»è¯‘é¡µé¢å‘½ä»¤æ‰§è¡Œå¤±è´¥:",e),{success:!1,error:e instanceof Error?e.message:"æœªçŸ¥é”™è¯¯"}}}async validateApiConfiguration(){var t,e;try{const s=await this.storageService.getUserSettings(),a=(t=s.apiConfigs)==null?void 0:t.find(o=>o.id===s.activeApiConfigId);return!((e=a==null?void 0:a.config)!=null&&e.apiKey)?{isValid:!1,errors:["APIå¯†é’¥æœªè®¾ç½®"]}:{isValid:!0,activeConfig:{id:a.id,provider:a.provider,hasApiKey:!!a.config.apiKey},errors:[]}}catch(s){return console.error("[CommandService] é…ç½®éªŒè¯å¤±è´¥:",s),{isValid:!1,errors:["é…ç½®éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"]}}}isCommandEnabled(t){return this.config.enabledCommands.includes(t)}enableCommand(t){this.config.enabledCommands.includes(t)||this.config.enabledCommands.push(t)}disableCommand(t){const e=this.config.enabledCommands.indexOf(t);e>-1&&this.config.enabledCommands.splice(e,1)}getEnabledCommands(){return[...this.config.enabledCommands]}setRequiresValidation(t){this.config.requiresValidation=t}async executeManualCommand(t){return this.isCommandEnabled(t)?this.executeCommand(t):{success:!1,error:`å‘½ä»¤æœªå¯ç”¨: ${t}`}}getAvailableCommands(){return Object.values(It)}updateConfig(t){this.config={...this.config,...t}}getConfig(){return{...this.config}}getCommandStats(){return{enabledCommands:this.config.enabledCommands.length,totalCommands:this.getAvailableCommands().length,requiresValidation:this.config.requiresValidation}}destroy(){D.instance=null}};h(D,"instance",null);let st=D;function q(i){try{return new URL(i).hostname}catch{const e=i.match(/(?:https?:\/\/)?(?:www\.)?([^\/]+)/);return e?e[1]:i}}function K(i){return`*://${i.replace(/^www\./,"")}/*`}function At(i){try{const t=new URL(i),e=t.pathname.endsWith("/")?t.pathname:`${t.pathname}*`;return`${t.protocol}//${t.host}${e}`}catch{return i}}function Ft(i,t){const e=t==="blacklist"?"é»‘åå•":"ç™½åå•";if(i.includes("*://")&&i.endsWith("/*")){const s=i.replace(/^\*:\/\//,"").replace(/\/\*$/,"");return`${e} - åŸŸå: ${s}`}else return`${e} - é¡µé¢: ${i}`}function Ht(i){const t=["chrome:","chrome-extension:","moz-extension:","edge:","about:"],e=i.includes("localhost")||i.includes("127.0.0.1"),s=t.some(a=>i.startsWith(a));return e||s}function Kt(i){if(!i||i.trim()==="")return{valid:!1,error:"URLä¸èƒ½ä¸ºç©º"};if(Ht(i))return{valid:!1,error:"æ— æ³•ä¸ºæµè§ˆå™¨å†…éƒ¨é¡µé¢æˆ–æœ¬åœ°åœ°å€åˆ›å»ºè§„åˆ™"};try{return new URL(i),{valid:!0}}catch{return{valid:!1,error:"URLæ ¼å¼æ— æ•ˆ"}}}class zt{constructor(t){h(this,"websiteManager");this.websiteManager=t}async init(){var t,e;try{n.contextMenus.onClicked.addListener(this.handleMenuClick.bind(this)),n.tabs.onUpdated.addListener(this.handleTabUpdate.bind(this)),n.tabs.onActivated.addListener(this.handleTabActivated.bind(this)),n.webNavigation.onCommitted.addListener(this.handleNavigation.bind(this));const s=await n.tabs.query({active:!0,currentWindow:!0});(t=s[0])!=null&&t.id&&((e=s[0])!=null&&e.url)&&await this.updateMenuState(s[0].id,s[0].url)}catch(s){console.error("èœå•ç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥:",s)}}async updateMenuState(t,e){if(!e||!e.startsWith("http")){await this.hideAllDynamicMenus();return}try{if(!Kt(e).valid){await this.hideAllDynamicMenus();return}const a=await this.websiteManager.getWebsiteStatus(e),r=q(e);await this.updateMenuVisibility(e,r,a)}catch(s){console.error("[ContextMenu] æ›´æ–°èœå•çŠ¶æ€å¤±è´¥:",{error:s instanceof Error?s.message:"æœªçŸ¥é”™è¯¯",url:e,tabId:t,stack:s instanceof Error?s.stack:void 0});try{const a=await this.websiteManager.getWebsiteStatus(e),r=q(e);await this.updateMenuVisibility(e,r,a)}catch(a){console.error("[ContextMenu] é‡è¯•å¤±è´¥ï¼Œéšè—æ‰€æœ‰èœå•:",a),await this.hideAllDynamicMenus()}}}async updateMenuVisibility(t,e,s){await this.hideAllDynamicMenus();try{s==="blacklisted"?(await n.contextMenus.update("illa-remove-blacklist",{visible:!0,title:`ä»é»‘åå•ä¸­ç§»é™¤ ${e}`}),await n.contextMenus.update("illa-add-whitelist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°ç™½åå•`}),await n.contextMenus.update("illa-add-whitelist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°ç™½åå•"})):s==="whitelisted"?(await n.contextMenus.update("illa-remove-whitelist",{visible:!0,title:`ä»ç™½åå•ä¸­ç§»é™¤ ${e}`}),await n.contextMenus.update("illa-add-blacklist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°é»‘åå•`}),await n.contextMenus.update("illa-add-blacklist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°é»‘åå•"})):(await n.contextMenus.update("illa-add-blacklist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°é»‘åå•`}),await n.contextMenus.update("illa-add-blacklist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°é»‘åå•"}),await n.contextMenus.update("illa-add-whitelist-domain",{visible:!0,title:`æ·»åŠ  ${e} åˆ°ç™½åå•`}),await n.contextMenus.update("illa-add-whitelist-exact",{visible:!0,title:"æ·»åŠ å½“å‰é¡µé¢åˆ°ç™½åå•"}))}catch(a){console.error("æ›´æ–°èœå•å¯è§æ€§å¤±è´¥:",a)}}async hideAllDynamicMenus(){const t=["illa-add-blacklist-domain","illa-add-blacklist-exact","illa-remove-blacklist","illa-add-whitelist-domain","illa-add-whitelist-exact","illa-remove-whitelist"];for(const e of t)try{await n.contextMenus.update(e,{visible:!1})}catch(s){console.error("æ›´æ–°èœå•å¯è§æ€§å¤±è´¥:",s)}}async handleMenuClick(t,e){if(!(e!=null&&e.url)){this.showNotification("æ“ä½œå¤±è´¥","æ— æ³•è·å–å½“å‰é¡µé¢ä¿¡æ¯");return}try{const s=e.url,a=q(s);if(t.menuItemId==="illa-open-settings"){const r=n.runtime.getURL("/options.html#website-management");await n.tabs.create({url:r});return}typeof t.menuItemId=="string"&&await this.processMenuAction(t.menuItemId,s,a)}catch(s){console.error("[ContextMenu] å¤„ç†èœå•ç‚¹å‡»å¤±è´¥:",{error:s instanceof Error?s.message:"æœªçŸ¥é”™è¯¯",menuItemId:t.menuItemId,url:e==null?void 0:e.url,stack:s instanceof Error?s.stack:void 0}),this.showNotification("æ“ä½œå¤±è´¥","å¤„ç†èœå•æ“ä½œæ—¶å‘ç”Ÿé”™è¯¯")}}async processMenuAction(t,e,s){let a,r,o;if(t.includes("add-blacklist-domain"))a="add-to-blacklist",r="domain",o=K(s);else if(t.includes("add-blacklist-exact"))a="add-to-blacklist",r="exact",o=At(e);else if(t.includes("add-whitelist-domain"))a="add-to-whitelist",r="domain",o=K(s);else if(t.includes("add-whitelist-exact"))a="add-to-whitelist",r="exact",o=At(e);else if(t.includes("remove-blacklist"))a="remove-from-blacklist",r="domain",o=K(s);else if(t.includes("remove-whitelist"))a="remove-from-whitelist",r="domain",o=K(s);else return;await this.executeAction(a,o,r,e)}async executeAction(t,e,s,a){var r,o;try{const c=t.includes("blacklist")?"blacklist":"whitelist",g=Ft(e,c);if(t.startsWith("add-to-")){await this.websiteManager.addRule(e,c,g);const w=c==="blacklist"?"é»‘åå•":"ç™½åå•",y=s==="domain"?"ç½‘ç«™":"é¡µé¢";this.showNotification("è§„åˆ™æ·»åŠ æˆåŠŸ",`å·²å°†${y}æ·»åŠ åˆ°${w}`)}else if(t.startsWith("remove-from-")){const w=await this.websiteManager.getRulesByType(c),y=q(a),m=K(y),I=w.filter(P=>{if(P.pattern===e||P.pattern===m)return!0;const lt=`*.${y}`;return P.pattern===lt});for(const P of I)await this.websiteManager.removeRule(P.id);const k=c==="blacklist"?"é»‘åå•":"ç™½åå•",F=I.length>0?"ç›¸å…³è§„åˆ™":"åŒ¹é…è§„åˆ™";this.showNotification("è§„åˆ™ç§»é™¤æˆåŠŸ",`å·²ä»${k}ä¸­ç§»é™¤${F}`)}const f=await n.tabs.query({active:!0,currentWindow:!0});(r=f[0])!=null&&r.id&&((o=f[0])!=null&&o.url)&&await this.updateMenuState(f[0].id,f[0].url)}catch(c){console.error("[ContextMenu] æ‰§è¡Œæ“ä½œå¤±è´¥:",{error:c instanceof Error?c.message:"æœªçŸ¥é”™è¯¯",action:t,pattern:e,patternType:s,url:a,stack:c instanceof Error?c.stack:void 0}),this.showNotification("æ“ä½œå¤±è´¥","æ‰§è¡Œæ“ä½œæ—¶å‘ç”Ÿé”™è¯¯")}}showNotification(t,e){n.notifications.create({type:"basic",iconUrl:n.runtime.getURL("/icon/48.png"),title:t,message:e})}async handleTabUpdate(t,e,s){(e.url||e.status==="complete"&&s.url||e.title)&&await this.updateMenuState(t,s.url)}async handleTabActivated(t){try{const e=await n.tabs.get(t.tabId);e.url&&await this.updateMenuState(t.tabId,e.url)}catch(e){console.error("å¤„ç†æ ‡ç­¾é¡µæ¿€æ´»äº‹ä»¶å¤±è´¥:",e)}}async handleNavigation(t){t.frameId===0&&t.url&&await this.updateMenuState(t.tabId,t.url)}}const qt=["\\","/",".","*","+","?","|","(",")","[","]","{","}","$","^"],Wt=i=>{let t="",e=0;for(;e<i.length;){const s=i[e++];switch(s){case"*":t+=".*";break;case"?":t+=".";break;case"[":let a="",r="";for(i[e]==="!"&&(a="^",e++);i[e]!=="]"&&i[e];){const o=i[e++];o==="-"?i[e]&&r?(a+=r+"-"+i[e++],r=""):(a+="\\-",r=""):(a+=o,r=o)}e++,t+="["+a+"]";break;case"\\":t+="\\"+i[e++];break;default:qt.indexOf(s)>-1&&(t+="\\"),t+=s;break}}return new RegExp("^"+t+"$")},St={match:(i,t)=>Wt(i).test(t)},W={rules:[]},j="website-management-settings",it="blacklist-settings";class jt{constructor(){h(this,"settingsCache",null);h(this,"cacheTimestamp",null)}async getWebsiteStatus(t){const e=await this.getSettings(),s=Date.now();this.cacheTimestamp&&s-this.cacheTimestamp>5e3&&this.clearCache();const a=e.rules.filter(o=>o.type==="blacklist"&&o.enabled);for(const o of a)if(St.match(o.pattern,t))return"blacklisted";const r=e.rules.filter(o=>o.type==="whitelist"&&o.enabled);for(const o of r)if(St.match(o.pattern,t))return"whitelisted";return"normal"}async isBlacklisted(t){return await this.getWebsiteStatus(t)==="blacklisted"}async isWhitelisted(t){return await this.getWebsiteStatus(t)==="whitelisted"}async getRules(){return(await this.getSettings()).rules}async getRulesByType(t){return this.clearCache(),(await this.getSettings()).rules.filter(s=>s.type===t)}async addRule(t,e,s){if(!t)return;this.clearCache();const a=await this.getSettings(),r=a.rules.find(c=>c.pattern===t);if(r){if(r.type===e)return;{const c=a.rules.findIndex(g=>g.id===r.id);c>-1&&a.rules.splice(c,1)}}const o={id:this.generateId(),pattern:t,type:e,enabled:!0,createdAt:new Date,description:s};a.rules.push(o),await this.saveSettings(a),this.clearCache()}async updateRule(t,e){const s=await this.getSettings(),a=s.rules.findIndex(r=>r.id===t);if(a===-1)throw new Error("è§„åˆ™ä¸å­˜åœ¨");s.rules[a]={...s.rules[a],...e},await this.saveSettings(s),this.clearCache()}async removeRule(t){const e=await this.getSettings(),s=e.rules.findIndex(a=>a.id===t);s>-1&&(e.rules.splice(s,1),await this.saveSettings(e),this.clearCache())}async removeRules(t){const e=await this.getSettings();e.rules=e.rules.filter(s=>!t.includes(s.id)),await this.saveSettings(e),this.clearCache()}async toggleRule(t){const e=await this.getSettings(),s=e.rules.find(a=>a.id===t);s&&(s.enabled=!s.enabled,await this.saveSettings(e),this.clearCache())}async getSettings(){if(this.settingsCache)return this.settingsCache;try{const t=await n.storage.sync.get(j);if(t&&t[j]){const s=JSON.parse(t[j]);return s.rules&&(s.rules=s.rules.map(a=>({...a,createdAt:new Date(a.createdAt)}))),this.settingsCache=s,this.cacheTimestamp=Date.now(),s}const e=await n.storage.sync.get(it);if(e&&e[it]){const s=JSON.parse(e[it]),a=await this.migrateLegacyData(s);return this.settingsCache=a,a}return this.settingsCache=W,W}catch(t){return console.error("è·å–ç½‘ç«™ç®¡ç†è®¾ç½®å¤±è´¥:",t),this.settingsCache=W,W}}async migrateLegacyData(t){const s={rules:t.patterns.map(a=>({id:this.generateId(),pattern:a,type:"blacklist",enabled:!0,createdAt:new Date,description:"ä»é»‘åå•è¿ç§»"}))};return await this.saveSettings(s),s}async saveSettings(t){try{const e=JSON.stringify(t);await n.storage.sync.set({[j]:e}),this.settingsCache=t,this.cacheTimestamp=Date.now()}catch(e){console.error("ä¿å­˜ç½‘ç«™ç®¡ç†è®¾ç½®å¤±è´¥:",e)}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}clearCache(){this.settingsCache=null,this.cacheTimestamp=null}}const O=class O{constructor(){h(this,"storageService");h(this,"contextMenuManager");h(this,"websiteManager");h(this,"runtimeInitialized",!1);this.storageService=R.getInstance(),this.websiteManager=new jt,this.contextMenuManager=new zt(this.websiteManager)}static getInstance(){return O.instance||(O.instance=new O),O.instance}async initializeRuntime(){if(!this.runtimeInitialized)try{await this.contextMenuManager.init(),this.runtimeInitialized=!0}catch(t){console.error("[InitializationService] è¿è¡Œæ—¶åˆå§‹åŒ–å¤±è´¥:",t)}}async handleInstallation(t){const e={success:!0,errors:[],warnings:[]};try{t.reason==="install"&&await this.performFirstTimeSetup(e),await this.initializeMenus(e)}catch(s){e.success=!1,e.errors.push(`åˆå§‹åŒ–å¤±è´¥: ${s instanceof Error?s.message:"æœªçŸ¥é”™è¯¯"}`)}return e}async performFirstTimeSetup(t){try{await this.storageService.saveUserSettings(p)}catch(e){t.errors.push("ä¿å­˜é»˜è®¤è®¾ç½®å¤±è´¥"+e);try{await n.storage.sync.set(p),t.warnings.push("ä½¿ç”¨äº†å¤‡ç”¨å­˜å‚¨æ–¹å¼")}catch(s){t.errors.push("å¤‡ç”¨å­˜å‚¨æ–¹å¼ä¹Ÿå¤±è´¥äº†"+s)}}}async initializeMenus(t){try{await this.createContextMenus()}catch(e){t.errors.push("å³é”®èœå•åˆå§‹åŒ–å¤±è´¥"+e)}}async createContextMenus(){await n.contextMenus.removeAll(),await n.contextMenus.create({id:T.MENU_PARENT_ID,title:"æµ¸å…¥å¼å­¦è¯­è¨€åŠ©æ‰‹",contexts:["page"]}),await n.contextMenus.create({id:"illa-separator",type:"separator",parentId:T.MENU_PARENT_ID,contexts:["page"]});const t=[{id:"illa-add-blacklist-domain",title:"æ·»åŠ åŸŸååˆ°é»‘åå•",visible:!1},{id:"illa-add-blacklist-exact",title:"æ·»åŠ å½“å‰é¡µé¢åˆ°é»‘åå•",visible:!1},{id:"illa-remove-blacklist",title:"ä»é»‘åå•ä¸­ç§»é™¤",visible:!1},{id:"illa-add-whitelist-domain",title:"æ·»åŠ åŸŸååˆ°ç™½åå•",visible:!1},{id:"illa-add-whitelist-exact",title:"æ·»åŠ å½“å‰é¡µé¢åˆ°ç™½åå•",visible:!1},{id:"illa-remove-whitelist",title:"ä»ç™½åå•ä¸­ç§»é™¤",visible:!1}];for(const e of t)await n.contextMenus.create({id:e.id,title:e.title,parentId:T.MENU_PARENT_ID,contexts:["page"],visible:e.visible});await n.contextMenus.create({id:"illa-settings-separator",type:"separator",parentId:T.MENU_PARENT_ID,contexts:["page"]}),await n.contextMenus.create({id:"illa-open-settings",title:"ç½‘ç«™ç®¡ç†è®¾ç½®",parentId:T.MENU_PARENT_ID,contexts:["page"]})}destroy(){O.instance=null}};h(O,"instance",null);let at=O;const $=class ${constructor(){h(this,"currentVersion");h(this,"checkInterval",864e5);h(this,"githubApiUrl","https://api.github.com/repos/xiao-zaiyi/illa-helper/releases/latest");h(this,"storageService");h(this,"intervalId");this.currentVersion=n.runtime.getManifest().version,this.storageService=R.getInstance()}static getInstance(){return $.instance||($.instance=new $),$.instance}async init(){setTimeout(()=>{this.checkForUpdates()},1e4),this.schedulePeriodicCheck(),this.setupNotificationListeners(),await this.checkPendingUpdate()}destroy(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=void 0)}schedulePeriodicCheck(){this.intervalId=setInterval(()=>{this.checkForUpdates()},this.checkInterval)}async handleMessage(t,e){switch(t.type){case"CHECK_UPDATE":try{const s=await this.checkForUpdates(!0);e(s)}catch(s){e({hasUpdate:!1,error:s instanceof Error?s.message:String(s)})}return!0;case"CLEAR_UPDATE_BADGE":try{await this.clearUpdateBadge(),e({success:!0})}catch(s){e({success:!1,error:s instanceof Error?s.message:String(s)})}return!0;case"DISMISS_UPDATE":try{await this.dismissUpdate(t.version),e({success:!0})}catch(s){e({success:!1,error:s instanceof Error?s.message:String(s)})}return!0;case"GET_UPDATE_INFO":try{const s=await this.getStoredUpdateInfo();e(s)}catch{e(null)}return!0;default:return!1}}setupNotificationListeners(){var t,e,s,a;(e=(t=n.notifications)==null?void 0:t.onClicked)==null||e.addListener(r=>{r.startsWith("update-available")&&this.handleNotificationClick(r)}),(a=(s=n.notifications)==null?void 0:s.onButtonClicked)==null||a.addListener((r,o)=>{r.startsWith("update-available")&&this.handleNotificationButtonClick(r,o)})}async checkForUpdates(t=!1){try{const e=await fetch(this.githubApiUrl,{headers:{Accept:"application/vnd.github+json","User-Agent":"side-translation"},cache:"no-cache"});if(!e.ok){const g=await e.text();throw console.error("[UpdateCheckService] GitHub API é”™è¯¯å“åº”:",g),new Error(`GitHub API è¯·æ±‚å¤±è´¥: ${e.status} - ${g.slice(0,100)}`)}const s=await e.json();if(s.prerelease||s.draft)return this.createUpdateInfo(!1,this.currentVersion);const a=s.tag_name.replace(/^v/,""),r=this.compareVersions(a,this.currentVersion)>0,o=this.parseDownloadAssets(s.assets||[]),c={hasUpdate:r,latestVersion:a,currentVersion:this.currentVersion,releaseNotes:s.body,downloadUrl:s.html_url,releaseDate:s.published_at,downloadAssets:o};return r?await this.handleUpdateAvailable(c,t):await this.setBadge(!1),await this.storeUpdateInfo(c),c}catch(e){return console.error("[UpdateCheckService] æ£€æŸ¥æ›´æ–°å¤±è´¥:",e),this.createUpdateInfo(!1,this.currentVersion)}}async handleUpdateAvailable(t,e=!1){const s=await this.getLastNotifiedVersion(),a=e?!1:await this.isUpdateDismissed(t.latestVersion);s!==t.latestVersion&&!a&&(await this.showUpdateNotification(t),await this.setLastNotifiedVersion(t.latestVersion)),a||await this.setBadge(!0)}async showUpdateNotification(t){try{const e=`update-available-${t.latestVersion}`;await n.notifications.create(e,{type:"basic",iconUrl:"/icon/128.png",title:"ğŸ‰ Side Translation æœ‰æ–°ç‰ˆæœ¬äº†ï¼",message:`å‘ç°æ–°ç‰ˆæœ¬ v${t.latestVersion}ï¼Œå½“å‰ç‰ˆæœ¬ v${t.currentVersion}ã€‚ç‚¹å‡»æŸ¥çœ‹æ›´æ–°è¯¦æƒ…ã€‚`,buttons:[{title:"æŸ¥çœ‹æ›´æ–°"},{title:"ç¨åæé†’"}]})}catch(e){console.error("[UpdateCheckService] æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:",e)}}async handleNotificationClick(t){const e=await this.getStoredUpdateInfo();e!=null&&e.downloadUrl&&n.tabs.create({url:e.downloadUrl}),n.notifications.clear(t)}async handleNotificationButtonClick(t,e){const s=await this.getStoredUpdateInfo();e===0&&(s!=null&&s.downloadUrl)&&n.tabs.create({url:s.downloadUrl}),n.notifications.clear(t)}async setBadge(t){try{t?(await n.action.setBadgeText({text:"NEW"}),await n.action.setBadgeBackgroundColor({color:"#ff4444"}),await n.action.setTitle({title:"Side Translation - æœ‰æ–°ç‰ˆæœ¬å¯ç”¨ï¼ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…"})):(await n.action.setBadgeText({text:""}),await n.action.setTitle({title:"Side Translation"}))}catch(e){console.error("[UpdateCheckService] è®¾ç½®å¾½ç« å¤±è´¥:",e)}}async clearUpdateBadge(){await this.setBadge(!1);const t=await this.getStoredUpdateInfo();t!=null&&t.latestVersion&&await this.dismissUpdate(t.latestVersion)}async dismissUpdate(t){const e=await this.getDismissedVersions();e.includes(t)||(e.push(t),await n.storage.local.set({dismissedUpdateVersions:e}))}compareVersions(t,e){const s=t.split(".").map(Number),a=e.split(".").map(Number),r=Math.max(s.length,a.length);for(let o=0;o<r;o++){const c=s[o]||0,g=a[o]||0;if(c>g)return 1;if(c<g)return-1}return 0}createUpdateInfo(t,e){return{hasUpdate:t,latestVersion:e,currentVersion:this.currentVersion}}async storeUpdateInfo(t){await n.storage.local.set({updateInfo:t,lastUpdateCheck:Date.now()})}async getStoredUpdateInfo(){return(await n.storage.local.get("updateInfo")).updateInfo||null}async checkPendingUpdate(){const t=await this.getStoredUpdateInfo();t!=null&&t.hasUpdate&&(await this.isUpdateDismissed(t.latestVersion)||await this.setBadge(!0))}async getLastNotifiedVersion(){return(await n.storage.local.get("lastNotifiedVersion")).lastNotifiedVersion||null}async setLastNotifiedVersion(t){await n.storage.local.set({lastNotifiedVersion:t})}async getDismissedVersions(){return(await n.storage.local.get("dismissedUpdateVersions")).dismissedUpdateVersions||[]}async isUpdateDismissed(t){return(await this.getDismissedVersions()).includes(t)}parseDownloadAssets(t){const e=[];for(const s of t){let a;const r=s.name.toLowerCase();r.includes("chrome")||r.includes(".crx")?a="chrome":r.includes("firefox")||r.includes(".xpi")?a="firefox":r.includes("edge")?a="edge":r.includes("safari")&&(a="safari"),e.push({name:s.name,downloadUrl:s.browser_download_url,size:s.size,browserType:a})}return e}};h($,"instance");let rt=$;var Et=(i=>(i.SETTINGS_UPDATED="settings_updated",i.WEBSITE_MANAGEMENT_UPDATED="website_management_updated",i.CONTEXT_MENU_ACTION="context-menu-action",i.NOTIFICATION="notification",i.ERROR="error",i))(Et||{});const E={tokenRefreshThreshold:600,tokenCheckInterval:120,maxRetryCount:3,retryDelay:1e3,authEndpoint:"https://side-translation.planktonfly.com/auth_token",apiBaseUrl:"https://side-translation.planktonfly.com/api",clientSecret:"Gp8kL4mX9nQ2wR7tY5vZ3bN6hJ1sA0cF"},Jt=E.clientSecret;function Yt(i,t){const e=t.toString().slice(0,-2),s=`${i}|${e}`;return Ct(s,Jt).then(a=>a.substring(0,32))}function Qt(i=16){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=new Uint8Array(i);return crypto.getRandomValues(e),Array.from(e,s=>t[s%t.length]).join("")}function Tt(i){if(i instanceof URLSearchParams){const t=[];return i.forEach((e,s)=>{t.push([s,e])}),t}if(typeof i=="string")return Tt(new URLSearchParams(i));if(i&&typeof i=="object"){const t=i.forEach;if(typeof t=="function"){const s=[];if(t.call(i,(a,r)=>{s.push([String(r),String(a??"")])}),s.length>0)return s}const e=i.entries;if(typeof e=="function"){const s=e.call(i);if(s&&Symbol.iterator in Object(s))return Array.from(s).map(([a,r])=>[String(a),String(r??"")])}return Object.entries(i).map(([s,a])=>[s,String(a??"")])}return[]}function Xt(i){return Tt(i).sort((e,s)=>{const a=e[0].localeCompare(s[0]);return a!==0?a:e[1].localeCompare(s[1])}).map(([e,s])=>`${e}=${s}`).join("&")}async function Zt(i){const t=new TextEncoder().encode(i),e=await crypto.subtle.digest("SHA-256",t);return bt(e)}async function Ct(i,t){const e=new TextEncoder().encode(t),s=new TextEncoder().encode(i),a=await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-256"},!1,["sign"]),r=await crypto.subtle.sign("HMAC",a,s);return bt(r)}function bt(i){return Array.from(new Uint8Array(i)).map(t=>t.toString(16).padStart(2,"0")).join("")}const te="ws://192.168.8.145:3000/log-ws",ee=2e3,se=5,ie=1200;function G(i,t=ie){return i.length<=t?i:`${i.slice(0,t)}...<truncated>`}function kt(i){return{type:"Error",name:i.name,message:i.message,stack:i.stack?G(i.stack,2e3):void 0}}function J(i){const t=new WeakSet;try{return JSON.stringify(i,(e,s)=>{if(s instanceof Error)return kt(s);if(typeof s=="bigint")return s.toString();if(s&&typeof s=="object"){const a=s;if(t.has(a))return"[Circular]";t.add(a)}return s},2)}catch{return String(i)}}function ae(i){return i instanceof Error?G(J(kt(i))):i instanceof Response?G(J({type:"Response",url:i.url,ok:i.ok,status:i.status,statusText:i.statusText,redirected:i.redirected})):i instanceof Request?G(J({type:"Request",url:i.url,method:i.method,mode:i.mode,credentials:i.credentials})):G(typeof i=="object"&&i!==null?J(i):String(i))}let C=null,B=!1,nt=0,Y=null,Q=!1;function re(){return new Date().toISOString()}function ne(i){if(i.length!==0)return i.map(t=>ae(t)).join(" ")}function oe(i){if(C&&C.readyState===WebSocket.OPEN)try{C.send(JSON.stringify(i))}catch{}}function Nt(){if(!(Q||B||C&&C.readyState===WebSocket.OPEN)){B=!0;try{C=new WebSocket(te),C.onopen=()=>{B=!1,nt=0},C.onclose=i=>{B=!1,C=null,vt()},C.onerror=()=>{B=!1},C.onmessage=i=>{}}catch{B=!1,vt()}}}function vt(){if(!Q){if(nt++,nt>=se){Q=!0;return}Y&&clearTimeout(Y),Y=setTimeout(()=>{Y=null,Nt()},ee)}}function ce(){if(typeof WebSocket>"u"){Q=!0;return}Nt()}function ot(i,t,e,...s){const a=ne(s),r=i==="error"?"error":i==="warn"?"warn":"log",o=i==="error"?"âŒ ":i==="warn"?"âš ï¸ ":"";console[r](`[${t}] ${o}${e}`,...s);const c={timestamp:re(),level:i,module:t,message:e,args:a};oe(c)}function xt(i){return{log:(t,...e)=>ot("log",i,t,...e),warn:(t,...e)=>ot("warn",i,t,...e),error:(t,...e)=>ot("error",i,t,...e)}}typeof window<"u"&&ce();class le{constructor(){h(this,"state",null);h(this,"refreshPromise",null);h(this,"initialized",!1);h(this,"hasAlarmCapability",!1)}async init(){if(this.initialized)return;const t=await chrome.storage.local.get(["authState","tempId"]);if(t.authState&&(this.state=t.authState),!t.tempId){const e=crypto.randomUUID();await chrome.storage.local.set({tempId:e})}this.hasAlarmCapability=this.canUseAlarmApi(),this.initialized=!0,this.startCheckLoop()}async getValidToken(){await this.init();const t=Date.now();return!this.state||t>=this.state.expiryTime?await this.refreshToken():t>=this.state.expiryTime-E.tokenRefreshThreshold*1e3&&this.refreshToken().catch(e=>{b.warn("Background token refresh failed",e)}),this.state.token}async refreshToken(t=!1){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this._doRefreshWithFallback(t);try{return await this.refreshPromise}finally{this.refreshPromise=null}}async _doRefreshWithFallback(t){try{return await this._doRefresh(t)}catch(e){if(!this.shouldFallbackToForceNew(e,t))throw e;b.warn("token_refresh_fallback_start",{reason:"token_revoked_or_expired",strategy:"retry_with_init_salt"});try{const s=await this._doRefresh(!0);return b.log("token_refresh_fallback_success",{strategy:"retry_with_init_salt"}),s}catch(s){throw b.error("token_refresh_fallback_failed",{strategy:"retry_with_init_salt",error:s instanceof Error?s.message:String(s)}),s}}}shouldFallbackToForceNew(t,e){var r;if(e||!((r=this.state)!=null&&r.token)||!(t instanceof Error))return!1;const s=t,a=/token revoked or expired/i.test(t.message);return s.status===401&&a}async _doRefresh(t){var y,m;const e=await chrome.storage.local.get(["tempId","userId"]),s=e.tempId,a=e.userId||"",r=Math.floor(Date.now()/1e3).toString(),o=chrome.runtime.id,c=chrome.runtime.getManifest().version.replace(/\./g,""),g={"Content-Type":"application/json","x-temp-id":s,"x-extension-id":o,"x-extension-version":c,"x-timestamp":r,"x-user-id":a};(y=this.state)!=null&&y.token&&!t?g.Authorization=`Bearer ${this.state.token}`:g["x-init-salt"]=await Yt(o,parseInt(r)),b.log("Refreshing token",{endpoint:E.authEndpoint,extensionId:o,extensionVersion:c,hasTempId:!!s,forceNew:t,hasOldToken:!!((m=this.state)!=null&&m.token&&!t),hasUserId:!!a});const f=await fetch(E.authEndpoint,{method:"POST",headers:g});if(!f.ok){const I=await f.text().catch(()=>"");let k=`Auth failed: ${f.status}`;try{k=JSON.parse(I).error||k}catch{I&&(k=I.slice(0,200))}b.error("Token refresh failed",{endpoint:E.authEndpoint,extensionId:o,extensionVersion:c,hasTempId:!!s,hasUserId:!!a,status:f.status,statusText:f.statusText,message:k,bodySnippet:I.slice(0,500)});const F=new Error(k);throw F.status=f.status,F}const w=await f.json();return this.state={token:w.token,expiryTime:Date.now()+w.expires_in*1e3,checkInterval:w.check_interval||E.tokenCheckInterval,userId:a},await chrome.storage.local.set({authState:this.state}),b.log("Token refresh succeeded",{expiresInSeconds:w.expires_in,checkInterval:w.check_interval,hasUserId:!!a}),this.state}startCheckLoop(){if(!this.hasAlarmCapability){b.log("Alarm API unavailable in current context, skip tokenCheck");return}try{chrome.alarms.create("tokenCheck",{periodInMinutes:E.tokenCheckInterval/60})}catch(t){b.warn("Failed to create tokenCheck alarm",t)}}async handleAlarm(){if(await this.init(),!this.state)return;const t=Date.now(),e=E.tokenRefreshThreshold*1e3;if(t>=this.state.expiryTime-e)try{await this.refreshToken(),b.log("Token refreshed by alarm")}catch(s){b.error("Alarm token refresh failed",s)}}async onLoginSuccess(t){await chrome.storage.local.set({userId:t}),await this.refreshToken(!0)}async onLogout(){this.state=null,await chrome.storage.local.remove(["authState","userId"]),await this.refreshToken(!0)}async checkAndRefreshIfNeeded(){if(await this.init(),!this.state){await this.refreshToken(!0);return}const t=Date.now(),e=E.tokenRefreshThreshold*1e3;t>=this.state.expiryTime-e&&await this.refreshToken()}canUseAlarmApi(){try{return typeof chrome<"u"&&!!chrome.alarms&&typeof chrome.alarms.create=="function"}catch{return!1}}}const b=xt("AuthManager"),A=new le,x=xt("RequestInterceptor"),ue="https://side-translation.planktonfly.com";function X(i){return i instanceof Error?{name:i.name,message:i.message,stack:i.stack}:{value:String(i)}}function de(i){return i.includes("/translate_tts")||i.includes("/translate_a/single")}class he{constructor(){h(this,"tempId",null);h(this,"extensionId");h(this,"extensionVersion");this.extensionId=chrome.runtime.id,this.extensionVersion=chrome.runtime.getManifest().version.replace(/\./g,"")}async init(){if(this.tempId)return;const t=await chrome.storage.local.get("tempId");this.tempId=t.tempId}async fetch(t,e={},s=0){if(await this.init(),await A.init(),!this.tempId){const m=await chrome.storage.local.get("tempId");this.tempId=m.tempId||null}const a=e.method||"GET";let r=t;try{r=this.resolveUrl(t)}catch(m){throw x.error("Failed to resolve request URL",{url:t,method:a,retryCount:s,error:X(m)}),m}let o="";try{o=await A.getValidToken()}catch(m){throw x.error("Failed to get valid token",{url:r,method:a,retryCount:s,error:X(m)}),m}const c=Math.floor(Date.now()/1e3).toString(),g=Qt(16);let f="";try{f=await this.calculateSign(a,r,e.body,c,o)}catch(m){throw x.error("Failed to calculate request signature",{url:r,method:a,retryCount:s,error:X(m)}),m}const w={...e.headers||{},Authorization:`Bearer ${o}`,"x-user-id":(await chrome.storage.local.get("userId")).userId||"","x-temp-id":this.tempId||"","x-timestamp":c,"x-nonce":g,"x-extension-id":this.extensionId,"x-extension-version":this.extensionVersion,"x-sign":f};this.tempId||x.warn("Missing tempId in request headers",{url:r,method:a,retryCount:s}),e.body&&typeof e.body=="object"&&(w["Content-Type"]="application/json",e.body=JSON.stringify(e.body));const y=de(r);y&&x.log("Request start",{url:r,rawUrl:t,method:a,retryCount:s,hasUserId:!!w["x-user-id"],hasTempId:!!w["x-temp-id"]});try{const m=await fetch(r,{...e,headers:w});if(y&&!m.ok){const I=await m.clone().text().then(k=>k.slice(0,500)).catch(()=>"");x.warn("Request returned non-OK status",{url:r,method:a,retryCount:s,status:m.status,statusText:m.statusText,bodySnippet:I})}if(m.status===401&&s<E.maxRetryCount){const I=await m.clone().json().catch(()=>({}));if(x.warn("Received 401 response",{url:r,method:a,retryCount:s,action:I.action||""}),I.action==="refresh_token")return await A.refreshToken(),this.fetch(t,e,s+1)}return m}catch(m){if(x.error("Request failed",{url:r,method:a,retryCount:s,error:X(m)}),s<E.maxRetryCount)return await this.delay(E.retryDelay*(s+1)),this.fetch(t,e,s+1);throw m}}async calculateSign(t,e,s,a,r){let o;const c=this.tempId||"";if(t==="GET"){const g=new URL(e);o=`${Xt(g.searchParams)}|${a}|${c}`}else{const g=typeof s=="string"?s:JSON.stringify(s||{});o=`${await Zt(g)}|${a}|${c}`}return Ct(o,r)}resolveUrl(t){return/^https?:\/\//i.test(t)?t:new URL(t,ue).toString()}async get(t,e={}){return this.fetch(t,{...e,method:"GET"})}async post(t,e,s={}){return this.fetch(t,{...s,method:"POST",body:e})}async put(t,e,s={}){return this.fetch(t,{...s,method:"PUT",body:e})}async delete(t,e={}){return this.fetch(t,{...e,method:"DELETE"})}delay(t){return new Promise(e=>setTimeout(e,t))}}new he;const fe=L(()=>{const i=R.getInstance(),t=tt.getInstance(),e=et.getInstance(),s=st.getInstance(),a=at.getInstance(),r=rt.getInstance();async function o(){try{await A.init(),s.initialize(),await r.init(),await a.initializeRuntime()}catch(l){console.error("[Background] æœåŠ¡åˆå§‹åŒ–å¤±è´¥:",l)}}n.runtime.onInstalled.addListener(async l=>{try{const u=await a.handleInstallation(l);u.success?u.warnings.length>0:console.error("[Background] å®‰è£…å¤„ç†å¤±è´¥:",u.errors),await A.checkAndRefreshIfNeeded()}catch(u){console.error("[Background] å®‰è£…å¤„ç†å¼‚å¸¸:",u)}}),n.runtime.onStartup.addListener(async()=>{await A.checkAndRefreshIfNeeded()}),chrome.alarms.onAlarm.addListener(async l=>{l.name==="tokenCheck"&&await A.handleAlarm()}),chrome.idle.onStateChanged.addListener(async l=>{l==="active"&&await A.checkAndRefreshIfNeeded()}),n.runtime.onMessage.addListener((l,u,d)=>{switch(l.type){case V.SHOW_NOTIFICATION:return c(l),!1;case V.OPEN_POPUP:return g(),!1;case V.OPEN_OPTIONS:return f(l),!1;case V.VALIDATE_CONFIG:return w(l,d),!0;case V.API_REQUEST:return y(l,d),!0;case Et.CONTEXT_MENU_ACTION:return m(l,d),!0;case V.SETTINGS_UPDATED:case V.API_CONFIG_UPDATED:return I(l,d),!0;case"CHECK_UPDATE":case"CLEAR_UPDATE_BADGE":case"DISMISS_UPDATE":case"GET_UPDATE_INFO":return k(l,d),!0;case"GET_TOKEN":return F(d),!0;case"LOGIN_SUCCESS":return P(l,d),!0;case"LOGOUT":return lt(d),!0;case"GET_AUTH_STATE":return me(d),!0;default:return!1}});async function c(l){try{await t.showNotification({type:"basic",title:l.options.title||"é€šçŸ¥",message:l.options.message||"",iconUrl:l.options.iconUrl})}catch(u){console.error("[Background] æ˜¾ç¤ºé€šçŸ¥å¤±è´¥:",u)}}async function g(){try{n.action.openPopup()}catch(l){console.error("[Background] æ— æ³•æ‰“å¼€popup:",l);const u=n.runtime.getURL(T.OPTIONS_PATH);n.tabs.create({url:u})}}async function f(l){let u=n.runtime.getURL(T.OPTIONS_PATH);l!=null&&l.hash&&(u+=l.hash),n.tabs.create({url:u})}function w(l,u){(async()=>{var d,z;try{const M=await i.getUserSettings(),ut=(d=M.apiConfigs)==null?void 0:d.find(pe=>pe.id===M.activeApiConfigId);if(!!((z=ut==null?void 0:ut.config)!=null&&z.apiKey)){u(!0);return}await t.showApiConfigError(l.source),u(!1)}catch(M){console.error("[Background] é…ç½®éªŒè¯å¤±è´¥:",M),u(!1)}})()}function y(l,u){(async()=>{try{const d=await e.handleApiRequest(l);u(d)}catch(d){console.error("[Background] APIè¯·æ±‚å¤„ç†å¤±è´¥:",d),u({success:!1,error:{message:d instanceof Error?d.message:"æœªçŸ¥é”™è¯¯"}})}})()}function m(l,u){(async()=>{try{u({success:!0,message:"å³é”®èœå•åŠ¨ä½œå·²å¤„ç†"})}catch(d){console.error("[Background] å³é”®èœå•åŠ¨ä½œå¤„ç†å¤±è´¥:",d),u({success:!1,error:{message:d instanceof Error?d.message:"æœªçŸ¥é”™è¯¯"}})}})()}function I(l,u){(async()=>{try{const d=await n.tabs.query({});let z=0;await Promise.all(d.filter(M=>typeof M.id=="number").map(async M=>{try{await n.tabs.sendMessage(M.id,l),z+=1}catch{}})),u({success:!0,delivered:z,totalTabs:d.length})}catch(d){console.error("[Background] è®¾ç½®æ›´æ–°è½¬å‘å¤±è´¥:",d),u({success:!1,error:d instanceof Error?d.message:"æœªçŸ¥é”™è¯¯"})}})()}function k(l,u){(async()=>{try{await r.handleMessage(l,u)||u({success:!1,error:{message:"æœªçŸ¥çš„æ›´æ–°æ¶ˆæ¯ç±»å‹"}})}catch(d){console.error("[Background] æ›´æ–°æ¶ˆæ¯å¤„ç†å¤±è´¥:",d),u({success:!1,error:{message:d instanceof Error?d.message:"æœªçŸ¥é”™è¯¯"}})}})()}function F(l){(async()=>{try{await A.init();const u=await A.getValidToken();l({token:u})}catch(u){l({error:u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯"})}})()}function P(l,u){(async()=>{try{await A.onLoginSuccess(l.userId),u({success:!0})}catch(d){u({success:!1,error:d instanceof Error?d.message:"æœªçŸ¥é”™è¯¯"})}})()}function lt(l){(async()=>{try{await A.onLogout(),l({success:!0})}catch(u){l({success:!1,error:u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯"})}})()}function me(l){(async()=>{try{await A.init();const u=await chrome.storage.local.get("authState");l({state:u.authState||null})}catch(u){l({error:u instanceof Error?u.message:"æœªçŸ¥é”™è¯¯"})}})()}o()});function Ie(){}function Z(i,...t){}const ge={debug:(...i)=>Z(console.debug,...i),log:(...i)=>Z(console.log,...i),warn:(...i)=>Z(console.warn,...i),error:(...i)=>Z(console.error,...i)};let ct;try{ct=fe.main(),ct instanceof Promise}catch(i){throw ge.error("The background crashed on startup!"),i}return ct}();
background;
